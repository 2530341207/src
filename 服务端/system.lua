---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by Admin.
--- DateTime: 2019/11/26 16:13
---
local lua_path = lualib:IO_GetLuaPath()
local package_path = package.path
package.path = string.format("%s;%s?.lua;%s?", package_path, lua_path, lua_path)
require("include/攻城战玩法")
require("system/自动打怪")
require("system/online_gift")
require("system/horse")
require("system/marry")
require("system/master")
require("system/征服系统")
require("system/装备加BUFF")
require("system/装备对技能加成")
require("system/设置行会人数")
require("system/英雄榜")
require("form/榜单")
require("form/转盘系统")
require("form/抢充礼包")
require("system/ShareConstant")
require("system/serializer")

--[[
local level_buff_t = {
    {1, 30, "10倍经验"},--大于等于1级，小于等于30级，给予BUFF
    {31, 35, "8倍经验"},
    {36, 40, "6倍经验"},
    {41, 45, "4倍经验"},
    {45, 999, "2倍经验"},
}--]]

local pklvlimit = 50--相差多少级不增加PK值

local distace = {1, 3, "经验倍数"}--最高等级必须大于多少级，相差几级，就给予BUFF(做个独立的分组)


local baobao_t = {21600, 21600}--宝宝判断时间 + 死亡时间(单位秒)

local ServerNewtime = "2019-12-28 09:00:00"                 ---最新引擎版本号(预设)
local Servertime = lualib:GetGSVer()                       ---当前引擎版本号(至少更新到支持GetGSVer接口的版本)
local ServerNewtime_int = lualib:Str2Time(ServerNewtime)   ---最新引擎版本号(预设)---数值型
local Servertime_int = lualib:Str2Time(Servertime)         ---当前引擎版本号(至少更新到支持GetGSVer接口的版本)---数值型

local StartServerTime = lualib:GetConstVar("StartServerTime")
local StartServerTime_int = lualib:Str2Time(StartServerTime)   ---常量表正式开区时间

local md5_list = {
    "A9B3E76445BDA32665B362618D40FD19", --此处为游戏安全信息查看工具中，疑似外挂的md5码
    "74FCEF15A04C745D94AF60C34F3D90CD",
    "C49EB512D415DDA878205DCB1EB30B40",
    "E3B41C88B266B96AEEB8EB4387E14212",
    "242F5CF699FE4CC24980BD1089B4963C",
    "BEDD229ABBB3584BF2E2D73EEE6796C5",
    "23B268EC2E0C26993DF767432E68EB8B",
    "0C08CDA04B4442403DC8DED30D2C8205",
    "A3B038C1CE09F8D5BE1649632093CA6D",
    "6F9DBD7CBBBE4F140127031C049A167B",
    "143B9ED91994E699BFB462A0E04E656D",
    "6776DBF11354EB0F99FFB6232269F1A8",	----更新至430外挂版本的MD5，希望大家多共享最新MD5！
}

local petskill = {--释放技能需要移除玩家宝宝(注意是技能索引名) = 1
    ["神兽（兽化印）"] = 1,
    ["召唤月灵1级"] = 1,
}

local itemtb = {--控制爆率道具
    "怒斩","逍遥扇","龙牙","屠龙","烈火剑法"
}

local tz_map = {--地图索引名 = 开启时间（距离开区时间单位秒）
    ["蛮荒西郊"] = 1728000,
    ["蛮荒东郊"] = 1728000,
    ["赤月大峡谷"] = 864000,
    ["神圣秘宝三层"] = 1728000, --20天
    ["神圣秘宝二层"] = 864000, --10天
    ["神圣秘宝一层"] = 259200,
    ["牛洞一层"] = 259200, --3天
    ["兽人古战场"] = 259200,
    ["幻境9"] = 864000,
}

local ss_msg = {
    [258900] = {"牛魔洞穴，不归之路，冰天雪地秘境一层还有5分钟开启，请大家做好准备！", false},
    [259200] = {"牛魔洞穴，不归之路，冰天雪地秘境一层已经开启，久玩神途祝大家游戏愉快！", false},
    [863700] = {"骨魔，赤月地图，幻境九、十层，冰天雪地秘境二层还有5分钟开启，请大家做好准备！", false},
    [864000] = {"骨魔，赤月地图，幻境九、十层，冰天雪地秘境二层已经开启，久玩神途祝大家游戏愉快！", false},
    [1727700] = {"蛮荒地图，噬魔，冰天雪地秘境三层还有5分钟开启，请大家做好准备！", false},
    [1728000] = {"蛮荒地图，噬魔，冰天雪地秘境三层已经开启，久玩神途祝大家游戏愉快！", false},
}

function on_pre_jump(player, from_map, to_map)
    local x = lualib:X(player)
    local y = lualib:Y(player)
    local now = lualib:GetAllTime()
    local start = lualib:GetConstVar("StartServerTime")
    local ser = lualib:Str2Time(start)
    local fromKey = lualib:KeyName(from_map)
    local toMap = lualib:KeyName(to_map)
    if tz_map[toMap] ~= nil then
        if now - ser < tz_map[toMap] then
            local second = tz_map[toMap] - (now - ser)
            if second <= 86400 then
                local str = string.format("%d时%d分%d秒",second/3600, second / 60 % 60, second % 60)
                lualib:SysTriggerMsg(player, "当前地图还有"..str.."开放，请注意系统公告！")
                return false
            else
                local str = math.floor(second/86400)
                lualib:SysTriggerMsg(player, "当前地图还有"..str.."天开放，请注意系统公告！")
                return false
            end
        else
            return true
        end
    end
    return true
end

function send_system_msg(obj, id)
    local now = lualib:GetAllTime()
    local start = lualib:GetConstVar("StartServerTime")
    local ser = lualib:Str2Time(start)
    local dis = now - ser
    if ss_msg[dis] ~= nil then
        lualib:SysMsg_SendCenterMsg(1, ss_msg[dis][1], "")
        lualib:SysMsg_SendCenterMsg(1, ss_msg[dis][1], "")
        lualib:SysMsg_SendCenterMsg(1, ss_msg[dis][1], "")
        lualib:SysMsg_SendCenterMsg(1, ss_msg[dis][1], "")
        lualib:SysMsg_SendBroadcastMsg(ss_msg[dis][1], "【系统】")
        lualib:SysMsg_SendBroadcastMsg(ss_msg[dis][1], "【系统】")
        lualib:SysMsg_SendBroadcastMsg(ss_msg[dis][1], "【系统】")
        lualib:SysMsg_SendBroadcastMsg(ss_msg[dis][1], "【系统】")
        if ss_msg[dis][2] then
            lualib:DisableTimer(obj, id)
            lualib:SetDBNumEx("map_lock", 1, 2)
        end
    end
end

function on_system_start()
    lualib:DelayCall("0",1,"摇钱树活动:main","")  --添加摇钱树活动
    lualib:DelayCall("0",1,"门派入侵:main","")  --添加门派入侵活动
    if lualib:GetDBNum("map_lock") == 0 then
        lualib:AddTimer("0", 10218, 1000, -1, "send_system_msg")
    end
    lualib:AddTrigger("0",  lua_trigger_pre_enter_jump, "on_pre_jump")
    --lualib:DelayCall("0", 1, "定时刷怪系统:check", "");
    lualib:AddTrigger("", lua_trigger_login, "on_player_login");
    lualib:AddTrigger("", lua_trigger_add_exp, "on_player_add_exp");		   --经验增加时
    lualib:AddTrigger("", lua_trigger_logout, "on_player_logout"); --退出游戏
    lualib:DelayCall("", 1, "OnFirstCastleWar", "");		                   --第一次攻城战
    lualib:AddTrigger("0",  lua_trigger_billin, "on_trigger_billin")                   --充值回调
    lualib:AddTrigger("0",  lua_trigger_billin_ex, "on_billinex")                   --充值回调不管玩家在不在线
    lualib:AddTrigger("0",  lua_trigger_first_in_game, "on_first_in_game")
    lualib:AddTrigger("0",  lua_trigger_level_up, "on_level_up")			   --升级触发
    lualib:AddTrigger("0",  lua_trigger_gp, "on_gp")				   --反外挂触发
    lualib:AddTrigger("0",  lua_trigger_castle_war_start, "on_castle_war_start")       --攻城开始
    lualib:AddTrigger("0",  lua_trigger_castle_war_end, "on_castle_war_end")           --攻城结束
    lualib:AddTrigger("0",  lua_trigger_player_relive, "on_player_relive")             --复活时回调
    lualib:AddTrigger("0",  lua_trigger_post_die, "on_post_die")                       --死亡时回调
    lualib:DelayCall("0", 1, "幸运的小猪:check", "")
    lualib:DelayCall("0", 1, "猪的传送门:check", "")
    lualib:AddTrigger("0", lua_trigger_attack, "on_attack");  --受攻击时回调
    lualib:AddTrigger("0", lua_trigger_item_appear, "on_item_appear"); --物品出现在地图时回调
    lualib:AddTrigger("0", lua_trigger_item_disappear, "on_item_disappear"); --物品消失在地图时回调
    lualib:AddTrigger("0",lua_trigger_create,"on_create") -- 物品创建时回调
    lualib:AddTrigger("0", lua_trigger_hack_check, "on_hack_check");
    lualib:AddTrigger("0", lua_trigger_hack_check2, "on_hack_check2");
    lualib:AddTrigger("0", lua_trigger_pre_process_pk, "on_pre_process_pk");
    lualib:AddTrigger("0", lua_trigger_pre_stall_buy, "on_pre_stall_buy")		--摆摊物品购买触发
    lualib:AddTrigger("0", lua_trigger_add_skill, "on_add_skill");   --添加技能回调
    lualib:AddTrigger("0", lua_trigger_monster_post_die, "on_post_monster_die")	   --怪物死亡回调
    lualib:AddTrigger("0", lua_trigger_player_post_die, "on_post_player_die");   --玩家死亡时
    lualib:AddTrigger("0", lua_trigger_item_apply, "on_item_apply");   --角色使用道具时回调
    lualib:AddTrigger("0", lua_trigger_pre_item_apply, "on_pre_item_apply");   --角色使用道具前回调
    lualib:AddTrigger("0",lua_trigger_post_drop_one,"on_post_drop_one")  --爆装备时回调
    lualib:AddTrigger("0",333,"on_pre_drop_one")  --爆某个具体物品之前回调.
    lualib:AddTrigger("0", 356, "on_pre_player_die")	   --玩家死亡前回调
    lualib:AddTrigger("0",  363, "on_ride_request")                                    --上马触发
    lualib:AddTrigger("0",  364, "on_unride_request")                                  --下马触发
    lualib:AddTrigger("0", 302, "on_post_equip")		                           --穿装备触发
    lualib:AddTrigger("0", 304, "on_post_un_equip") 	                           --脱装备触发
    lualib:AddTrigger("0", 301, "on_pre_equip") 	                           --穿装备前触发
    lualib:AddTrigger("0", 374, "on_pre_harm")			                   --受伤前触发
    lualib:AddTrigger("0", lua_trigger_family_ntf, "on_family_ntf")
    lualib:AddTrigger("0",lua_trigger_login, "luadistributions:玩家登陆游戏")
    lualib:AddTrigger("0",lua_trigger_billin_ex ,"luadistributions:充值强制回调")
    lualib:AddTrigger("0",lua_trigger_billin ,"luadistributions:充值回调")
    lualib:AddTrigger("0", lua_trigger_pre_mining, "on_pre_mining");   --挖矿前回掉
    lualib:AddTrigger("0", lua_trigger_kill, "on_kill")
    lualib:AddTrigger("0", 362, "on_pre_logout")                      --玩家离开游戏前触发
    lualib:AddTrigger("0", lua_trigger_spell, "on_spell")--释放技能后触发
    lualib:AddTrigger("0", lua_trigger_pre_spell , "on_pre_spell")--使用技能之前回调.
    lualib:AddTrigger("0",  lua_trigger_pre_stall, "on_pre_stall")--摆摊触发
    lualib:AddTrigger("0",  lua_trigger_catch, "on_catch")--宝宝触发
    lualib:AddTrigger("0",  lua_trigger_pre_catch, "on_pre_catch")--抓宝宝前触发
    lualib:AddTrigger("0",  lua_trigger_mall, "on_mall")--玩家在商城消费时回调.
    lualib:AddTrigger("0",  lua_trigger_pre_level_up, "on_pre_level_up")--角色升级前回调.
    lualib:AddTrigger("0",  lua_trigger_item_pickup, "on_item_pickup")
    lualib:AddTrigger("0",  373, "on_pre_curse") --玩家武器被诅咒前触发
    lualib:AddTrigger("0",  351, "on_monster_born") --怪物出生时回调
    lualib:AddTrigger("0", lua_trigger_family_member_ntf, "on_family_member_ntf");   --触发行会事件
    lualib:AddTrigger("0",lua_trigger_servant_betry,"on_servant_betry") -- 宝宝叛变触发
    lualib:AddTrigger("0",lua_trigger_add_exp,"on_add_exp")
    lualib:AddTrigger("0",358,"on_pre_monster_die")    --怪物死亡前回调
    lualib:AddTrigger("0", lua_trigger_leave_map , "on_leave_map") -- 玩家离开地图回调
    lualib:AddTrigger("0", lua_trigger_enter_map  , "on_enter_map") -- 玩家离开地图回调

    --lualib:AddTrigger("0",lua_trigger_item_dur_zero_ex,"on_item_dur_zero_ex")  --角色装备耐久为0时回调扩展
    --lualib:AddTrigger("0",348,"on_item_dur_zero")  --角色装备耐久为0时回调扩展
    if not lualib:HasTimer("0", 20170711) then
        lualib:AddTimer("0", 20170711, 1000, -1, "转盘系统:Lfte_cz")
    end

    if not lualib:HasTimer("0", 20200118) then
        lualib:AddTimer("0", 20200118, 1000, -1, "gongcheng_ts")
    end

    on_setfamily_people()
    local StartServerTime = lualib:GetConstVar("StartServerTime")
    local StartServerTime_int = lualib:Str2Time(StartServerTime)
    local times = lualib:GetAllTime()
    local daysss = 86400*3
    if times < StartServerTime_int then
        lualib:AddTimer("0",40,(StartServerTime_int-times)*1000,1,"kaiquchuansong")
        lualib:AddTimer("0",10121,1000,-1,"judgmentTime1")  --每隔1秒调用一次judgmentTime1 10121   --A
    elseif times >= StartServerTime_int and 5*60 + daysss > times - StartServerTime_int then   --当前时间大于开区时间且小于5分钟
        lualib:AddTimer("0",10122,1000,-1,"judgmentTime1")  	--定时器10122											--B
    else														--当前时间大于开区时间5分钟
        local timess = times - StartServerTime_int
        local mod = math.fmod(timess,3*60*60)
        local dMod = 5*60 - mod
        if mod == 0 then										--等于0时
            local map = lualib:Map_GetMapGuid("巫山城")
            lualib:Map_GenNpc(map,"神圣秘宝",444,269,0,4)
            lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来探索把！！！","冰天雪地秘境")
            lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来探索把！！！","冰天雪地秘境")
            lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来探索把！！！","冰天雪地秘境")

            lualib:AddTimer("0",10123,5*60*1000,1,"delNpc")  ---添加定时器5分钟后删除NPC								--C	X
        lualib:AddTimer("0",10124,3*60*60*1000,-1,"addNpc") ---添加定时器两小时后添加npc							--D

        elseif 0 < dMod then								--当前时间大于开区时间并且不是召唤NPC时间，但是小于NPC消失时间
            local map = lualib:Map_GetMapGuid("巫山城")
            lualib:Map_GenNpc(map,"神圣秘宝",444,296,0,4)
            lualib:AddTimer("0",10125,dMod*1000,1,"delNpc")																	--E	 X
            lualib:AddTimer("0",10126,5*60*1000,1,"excessive")
            --F  X
        else
            lualib:AddTimer("0",10127,1000,-1,"judgmentTime2")  --定时器10123											--G
        end
    end
    local tbbbb = {["max"] = 0,["daynum"] = 0,["hasgot"] = 0,["can"] = "",["hasdrop"] = {},["isopen"] = 0}
    --{["max"] = 0,["daynum"] = 0,["hasgot"] = 0,["can"] = "",["hasdrop"] = {}}
    for i,v in pairs(itemtb) do
        if lualib:GetDBStr(v) == "" then
            local jsonStr = json.encode(tbbbb)
            lualib:SetDBStrEx(v,jsonStr,6)
        end
    end
    local GQQC = {"00:00:00"}
    lualib:AddScheduled(10020876,"国庆有礼",5,GQQC,"tonum","")


    -- 每当系统重启，需要重新更换题目
    lualib:SetDBNum("dayQuestionDB", 0)
end

function gongcheng_ts()
    local CastleWar = lualib:GetConstVar("CastleWar")
    local castle_time = lualib:Str2Time(CastleWar)
    local times = lualib:GetAllTime()
    if times == castle_time - 60*60 then
        lualib:DisableTimer("0",20200118)
        lualib:AddTimer("0",19950414,5*60*1000,-1,"gc_ts")
    end
end

function gc_ts()
    lualib:SysMsg_SendBroadcastMsg("神歌城攻城战定于今晚20:00开始，请玩家们做好准备！！！","神歌城攻城战")
    lualib:SysMsg_SendBroadcastMsg("神歌城攻城战定于今晚20:00开始，请玩家们做好准备！！！","神歌城攻城战")
    lualib:SysMsg_SendBroadcastMsg("神歌城攻城战定于今晚20:00开始，请玩家们做好准备！！！","神歌城攻城战")
    lualib:SysMsg_SendBroadcastMsg("神歌城攻城战定于今晚20:00开始，请玩家们做好准备！！！","神歌城攻城战")
    lualib:SysMsg_SendBroadcastMsg("神歌城攻城战定于今晚20:00开始，请玩家们做好准备！！！","神歌城攻城战")
end

function judgmentTime1()
    local StartServerTime = lualib:GetConstVar("StartServerTime")
    local StartServerTime_int = lualib:Str2Time(StartServerTime)
    local times = lualib:GetAllTime()


    local timess = times - StartServerTime_int - 3*60*60 - 86400*3
    if timess == 0 then
        lualib:DisableTimer("0",10121) --删除定时器10121																--删除A
        lualib:DisableTimer("0",10122) --删除定时器10122																--删除B
        local map = lualib:Map_GetMapGuid("巫山城")
        lualib:Map_GenNpc(map,"神圣秘宝",444,296,0,4)
        lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
        lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
        lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
        lualib:AddTimer("0",10128,5*60*1000,1,"delNpc")																	--H X
        lualib:AddTimer("0",10129,3*60*60*1000,-1,"addNpc") ---添加定时器												--I
    else
        return false
    end

end


function judgmentTime2()    ---开区后
local StartServerTime = lualib:GetConstVar("StartServerTime")
    local StartServerTime_int = lualib:Str2Time(StartServerTime)
    local times = lualib:GetAllTime()

    local timess = times - StartServerTime_int
    local mod = math.fmod(timess,3*60*60)
    if mod ==0 then			--等于0时，到达2小时时间
        lualib:DisableTimer("0",10127)  --删除定时器10127
        lualib:DisableTimer("0",10134)  --删除定时器10134
        local map = lualib:Map_GetMapGuid("巫山城")
        lualib:Map_GenNpc(map,"神圣秘宝",444,296,0,4)
        lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
        lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
        lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
        lualib:AddTimer("0",10130,5*60*1000,1,"delNpc")																	--J X
        lualib:AddTimer("0",10131,3*60*60*1000,-1,"addNpc")																--K
    else
        return false																--M X
    end
end



function excessive()
    lualib:AddTimer("0",10134,1000,-1,"judgmentTime2")																	--N
end



function addNpc()
    local map = lualib:Map_GetMapGuid("巫山城")
    lualib:Map_GenNpc(map,"神圣秘宝",444,296,0,4)
    lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
    lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
    lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境刷新，5分钟后删除，入口在地图；巫山城(444，296)，快来刷怪吧！！！","冰天雪地秘境")
    lualib:AddTimer("0",10135,5*60*1000,1,"delNpc") --定时删除npc														--P X
end


function delNpc()
    local map = lualib:Map_GetMapGuid("巫山城")
    local npc1 = lualib:Map_GetMapNpc(map,"神圣秘宝")
    lualib:Npc_Remove(npc1)  --删除npc
    lualib: SysMsg_SendBroadcastMsg("冰天雪地秘境关闭入口，2小时55分钟后再刷新","冰天雪地秘境")
end


function on_mall(player, yb, bind, item)
    local tab = {
        ["9朵玫瑰花"] ={60000, 900},
        ["99朵玫瑰花"] ={660000, 9900},
        ["999朵玫瑰花"] ={8880000, 50000},
    }
    local keyName = lualib:KeyName(item)
    if tab[keyName] ~= nil  then
        --local num = math.floor(yb/tab[keyName][2])
        --if num > 0 then
        if lualib:Player_AddGold(player, tab[keyName][1], true, "加金币：购买玫瑰", player) then
            lualib:SysWarnMsg(player, "商城购买玫瑰获得绑定金币"..tab[keyName][1].."枚.")
        end
        --end
    end
end

local skilltb = {
    {"烈火剑法1级",0.07,"审判之杖",""},
    {"烈火剑法2级",0.07,"审判之杖",""},
    {"烈火剑法3级",0.07,"审判之杖",""},
    {"烈火剑法4级",0.07,"审判之杖",""},
    {"烈火（雷神印）",0.07,"审判之杖",""},
    {"烈火（燃烧印）",0.07,"审判之杖",""},
    {"烈火（追月印）",0.07,"审判之杖",""},
    {"雷电术1级",0.05,"古玉法杖",""},
    {"雷电术2级",0.05,"古玉法杖",""},
    {"雷电术3级",0.05,"古玉法杖",""},
    {"雷电术4级",0.05,"古玉法杖",""},
    {"雷电术（天雷印）",0.05,"古玉法杖",""},
    {"雷电术（五雷印）",0.05,"古玉法杖",""},
    {"裂地斩1级",0.1,"怒戦",""},
    {"裂地斩2级",0.1,"怒戦",""},
    {"裂地斩3级",0.1,"怒戦",""},
    {"裂地斩4级",0.1,"怒戦",""},
    {"开天（追龙印）",0.1,"怒戦",""},
    {"开天（血龙印）",0.1,"怒戦",""},
    {"开天（冰龙印）",0.1,"怒戦",""},
    {"陨星灭世1级",0.1,"巃牙",""},
    {"陨星灭世2级",0.1,"巃牙",""},
    {"陨星灭世3级",0.1,"巃牙",""},
    {"陨星灭世4级",0.1,"巃牙",""},
    {"火雨（黑雨印）",0.1,"巃牙",""},
    {"烈火剑法1级",0.15,"屠巃",""},
    {"烈火剑法2级",0.15,"屠巃",""},
    {"烈火剑法3级",0.15,"屠巃",""},
    {"烈火剑法4级",0.15,"屠巃",""},
    {"烈火（雷神印）",0.15,"屠巃",""},
    {"烈火（燃烧印）",0.15,"屠巃",""},
    {"烈火（追月印）",0.15,"屠巃",""},
    {"冰咆哮1级",0.1,"魔魂法杖",""},
    {"冰咆哮2级",0.1,"魔魂法杖",""},
    {"冰咆哮3级",0.1,"魔魂法杖",""},
    {"冰咆哮4级",0.1,"魔魂法杖",""},
    {"冰咆哮（暴雨印）",0.1,"魔魂法杖",""},
    {"冰咆哮（冰雨印）",0.1,"魔魂法杖",""},
    {"冰咆哮（火雨印）",0.1,"魔魂法杖",""},
    {"烈火剑法1级",0.15,"古剑无名",""},
    {"烈火剑法2级",0.15,"古剑无名",""},
    {"烈火剑法3级",0.15,"古剑无名",""},
    {"烈火剑法4级",0.15,"古剑无名",""},
    {"烈火（雷神印）",0.15,"古剑无名",""},
    {"烈火（燃烧印）",0.15,"古剑无名",""},
    {"烈火（追月印）",0.15,"古剑无名",""},
    {"裂地斩1级",0.15,"古剑无名",""},
    {"裂地斩2级",0.15,"古剑无名",""},
    {"裂地斩3级",0.15,"古剑无名",""},
    {"裂地斩4级",0.15,"古剑无名",""},
    {"开天（冰龙印）",0.15,"古剑无名",""},
    {"开天（血龙印）",0.15,"古剑无名",""},
    {"开天（追龙印）",0.15,"古剑无名",""},
    {"烈火剑法1级",0.15,"龙血宝刀",""},
    {"烈火剑法2级",0.15,"龙血宝刀",""},
    {"烈火剑法3级",0.15,"龙血宝刀",""},
    {"烈火剑法4级",0.15,"龙血宝刀",""},
    {"烈火（雷神印）",0.15,"龙血宝刀",""},
    {"烈火（燃烧印）",0.15,"龙血宝刀",""},
    {"烈火（追月印）",0.15,"龙血宝刀",""},
    {"裂地斩1级",0.15,"龙血宝刀",""},
    {"裂地斩2级",0.15,"龙血宝刀",""},
    {"裂地斩3级",0.15,"龙血宝刀",""},
    {"裂地斩4级",0.15,"龙血宝刀",""},
    {"开天（冰龙印）",0.15,"龙血宝刀",""},
    {"开天（血龙印）",0.15,"龙血宝刀",""},
    {"开天（追龙印）",0.15,"龙血宝刀",""},
    {"烈火剑法1级",0.15,"幽冥鬼斩",""},
    {"烈火剑法2级",0.15,"幽冥鬼斩",""},
    {"烈火剑法3级",0.15,"幽冥鬼斩",""},
    {"烈火剑法4级",0.15,"幽冥鬼斩",""},
    {"烈火（雷神印）",0.15,"幽冥鬼斩",""},
    {"烈火（燃烧印）",0.15,"幽冥鬼斩",""},
    {"烈火（追月印）",0.15,"幽冥鬼斩",""},
    {"裂地斩1级",0.15,"幽冥鬼斩",""},
    {"裂地斩2级",0.15,"幽冥鬼斩",""},
    {"裂地斩3级",0.15,"幽冥鬼斩",""},
    {"裂地斩4级",0.15,"幽冥鬼斩",""},
    {"开天（冰龙印）",0.15,"幽冥鬼斩",""},
    {"开天（血龙印）",0.15,"幽冥鬼斩",""},
    {"开天（追龙印）",0.15,"幽冥鬼斩",""},
    {"冰咆哮1级",0.15,"七星法杖",""},
    {"冰咆哮2级",0.15,"七星法杖",""},
    {"冰咆哮3级",0.15,"七星法杖",""},
    {"冰咆哮4级",0.15,"七星法杖",""},
    {"冰咆哮（暴雨印）",0.15,"七星法杖",""},
    {"冰咆哮（冰雨印）",0.15,"七星法杖",""},
    {"冰咆哮（火雨印）",0.15,"七星法杖",""},
    {"陨星灭世1级",0.1,"七星法杖",""},
    {"陨星灭世2级",0.1,"七星法杖",""},
    {"陨星灭世3级",0.1,"七星法杖",""},
    {"陨星灭世4级",0.1,"七星法杖",""},
    {"火雨（黑雨印）",0.1,"七星法杖",""},
    {"冰咆哮1级",0.15,"火灵权杖",""},
    {"冰咆哮2级",0.15,"火灵权杖",""},
    {"冰咆哮3级",0.15,"火灵权杖",""},
    {"冰咆哮4级",0.15,"火灵权杖",""},
    {"冰咆哮（暴雨印）",0.15,"火灵权杖",""},
    {"冰咆哮（冰雨印）",0.15,"火灵权杖",""},
    {"冰咆哮（火雨印）",0.15,"火灵权杖",""},
    {"陨星灭世1级",0.1,"火灵权杖",""},
    {"陨星灭世2级",0.1,"火灵权杖",""},
    {"陨星灭世3级",0.1,"火灵权杖",""},
    {"陨星灭世4级",0.1,"火灵权杖",""},
    {"火雨（黑雨印）",0.1,"火灵权杖",""},
    {"冰咆哮1级",0.15,"寒玉剑",""},
    {"冰咆哮2级",0.15,"寒玉剑",""},
    {"冰咆哮3级",0.15,"寒玉剑",""},
    {"冰咆哮4级",0.15,"寒玉剑",""},
    {"冰咆哮（暴雨印）",0.15,"寒玉剑",""},
    {"冰咆哮（冰雨印）",0.15,"寒玉剑",""},
    {"冰咆哮（火雨印）",0.15,"寒玉剑",""},
    {"陨星灭世1级",0.1,"寒玉剑",""},
    {"陨星灭世2级",0.1,"寒玉剑",""},
    {"陨星灭世3级",0.1,"寒玉剑",""},
    {"陨星灭世4级",0.1,"寒玉剑",""},
    {"火雨（黑雨印）",0.1,"寒玉剑",""},
    {"召唤骷髅1级",0,"火冥宝剑",""},
    {"召唤骷髅2级",0,"火冥宝剑",""},
    {"召唤骷髅3级",0,"火冥宝剑",""},
    {"召唤骷髅4级",0,"火冥宝剑",""},
    {"召唤神兽1级",0,"火冥宝剑",""},
    {"召唤神兽2级",0,"火冥宝剑",""},
    {"召唤神兽3级",0,"火冥宝剑",""},
    {"召唤神兽4级",0,"火冥宝剑",""},
    {"骷髅（射手印）",0,"火冥宝剑",""},
    {"骷髅（战将印）",0,"火冥宝剑",""},
    {"骷髅（帝王印）",0,"火冥宝剑",""},
    {"神兽（圣兽印）",0,"火冥宝剑",""},
    {"神兽（血兽印）",0,"火冥宝剑",""},
    {"神兽（天神印）",0,"火冥宝剑",""},
    {"火符（道尊印）",0.1,"火冥宝剑",""},
    {"火符（破空印）",0.1,"火冥宝剑",""},
    {"灵魂火符1级",0.1,"火冥宝剑",""},
    {"灵魂火符2级",0.1,"火冥宝剑",""},
    {"灵魂火符3级",0.1,"火冥宝剑",""},
    {"灵魂火符4级",0.1,"火冥宝剑",""},
    {"火符（道尊印）",0.1,"毒龙剑",""},
    {"火符（破空印）",0.1,"毒龙剑",""},
    {"灵魂火符1级",0.1,"毒龙剑",""},
    {"灵魂火符2级",0.1,"毒龙剑",""},
    {"灵魂火符3级",0.1,"毒龙剑",""},
    {"灵魂火符4级",0.1,"毒龙剑",""},
    {"火符（道尊印）",0.1,"孔雀翎",""},
    {"火符（破空印）",0.1,"孔雀翎",""},
    {"灵魂火符1级",0.1,"孔雀翎",""},
    {"灵魂火符2级",0.1,"孔雀翎",""},
    {"灵魂火符3级",0.1,"孔雀翎",""},
    {"灵魂火符4级",0.1,"孔雀翎",""},
}

local chonglei = {"虫虫","盔甲虫","威思而小虫","巨型多角虫暗","洞蛆","楔蛾","角蝇","蝙蝠","粪虫","跳跳蜂","巨型蠕虫","威思儿小虫","黑色恶蛆","邪恶钳虫","钳虫","赤甲虫","蜈蚣","巨型多角虫","多角虫"}

local yezhu = {"白野猪","白野猪暗","白野猪药","白野猪1","白野猪3","白野猪暴徒","红野猪","红野猪极","红野猪大爆","红野猪1","红野猪2","黑野猪","黑野猪极","黑野猪1","黑野猪大爆","黑野猪2",
               "祖犸弓箭手","祖犸雕像","祖犸卫士","祖犸雕像普","祖犸弓手普","祖犸卫士普","祖犸卫士超","祖犸卫士极书","祖犸弓手极装","祖犸雕像极装","祖犸卫士普阁","祖犸雕像普阁","祖犸弓手普阁","祖犸弓手极假",
               "祖犸卫士极假","祖犸雕像极假","祖犸卫士统领","祖犸弓手极书","祖犸雕像极书","祖犸卫士极装","祖犸卫士印忠"}



function on_pre_harm(strRole,strAttacker,iHp,iDefense,strKillKey,IsBurst)
    local cur_hp = lualib:Hp(strAttacker, false)
    local max_hp = lualib:Hp(strAttacker, true)
    local cur_mp = lualib:Mp(strAttacker, false)
    if lualib:Player_IsPlayer(strAttacker) then
        local weapon = lualib:Weapon(strAttacker)
        if weapon == "" then
            return iHp
        end
        local wq_name = lualib:Name(weapon)
        for i=1,#skilltb do
            if wq_name == skilltb[i][3] then
                if lualib:HasSkill(strAttacker,skilltb[i][1],false) then
                    if skilltb[i][1] == strKillKey then
                        iHp = math.floor(iHp*skilltb[i][2]) + iHp
                    end
                end
            end
        end

        if lualib:HasSkill(strAttacker,"火符（摄魂印）",false) then
            if strKillKey == "火符（摄魂印）" then
                if cur_hp <= max_hp then
                    lualib:SetHp(strAttacker,cur_hp+5,false)
                    lualib:SetMp(strAttacker,cur_mp+5, false)
                    lualib:ShowRoleHPRef("",strAttacker,5)
                end
            end
        end

    end

    if lualib:Monster_IsMonster(strRole) then
        if lualib:HasSkill(strAttacker,"半月（疾月印）",false) then
            if strKillKey == "半月（疾月印）" then
                lualib:AddBuff(strAttacker,"半月（疾月印）",0)
            end
        end

        if lualib:HasSkill(strAttacker,"基本（萤光印）",false) then
            local key_name = lualib:KeyName(strRole)
            for i=1,#chonglei do
                if key_name == chonglei[i] then
                    iHp = math.floor(iHp*1.2)
                end
            end
        end

        if lualib:HasSkill(strAttacker,"攻杀（统治印）",false) then
            local key_name1 = lualib:KeyName(strRole)
            for i=1,#yezhu do
                if key_name1 == yezhu[i] then
                    iHp = math.floor(iHp*1.2)
                end
            end
        end

        if lualib:HasSkill(strAttacker,"精神（道法印）",false) then
            if strKillKey == "普通物理攻击" then
                lualib:AddBuff(strAttacker,"精神（道法印）",0)
            end
        end
    end

    if lualib:Player_IsPlayer(strRole) then
        if lualib:HasBuff(strRole,"魔法盾冰霜印") then
            lualib:AddBuff(strAttacker,"开天冰龙印",0)
        end
    end
    if lualib:Player_IsPlayer(strRole) then
        if lualib:HasBuff(strRole,"魔法盾金刚印") then
            --lualib:AddBuff(strAttacker,"开天冰龙印",0)
            local rnd = math.random(1,100)
            --lualib:SysMsg_SendBroadcastMsg(tostring(rnd), "rnd")
            local teststr = ""
            if rnd <= 30 then
                lualib:AddBuff(strRole,"金刚盾守护",10)
            end
            --lualib:SysMsg_SendBroadcastMsg(teststr, "ooop")

        end
    end

    return iHp
end

function on_pre_level_up(player, level)
    local now = lualib:GetAllTime()
    local start = lualib:GetConstVar("StartServerTime")
    local ser = lualib:Str2Time(start)
    local dis = now - ser - 28800          --  返回值是距 "1970-1-1 8:00:00" 的秒数   不是0点
    if dis >= 0 and dis < 86400 and level == 40 then
        return false
    end
    if dis >= 86400 and dis < 86400*3 and level == 45 then
        return false
    end
    if dis >= 86400*3 and dis < 86400*10 and level == 50 then
        return false
    end
    if dis >= 86400*10 and dis < 86400*20 and level == 55 then
        return false
    end
    return true
end

function on_pre_stall_buy(buy, sell, item, total, num, types)
    lualib:DelayCall(sell, 8, "摆摊收税:set_total_value", total.."#"..types)
    return total
end

function on_pre_process_pk(killer, player)
    if lualib:Level(killer) - lualib:Level(player) >= pklvlimit then
        return false
    end
    return true
end

local bb_key = {"祖犸卫士超","祖犸卫士极书","祖犸卫士极假","祖犸卫士极装","祖犸弓手极装","祖犸弓手极假","祖犸弓手极书","祖犸雕像极装","祖犸雕像极假","祖犸雕像极书"}



function shanbianl(player)
    local bb_tb = lualib:Player_GetServantList(player)
    if bb_tb ~= nil or table.getn(bb_tb) ~= 0 then
        for i=1,#bb_tb do
            for j=1,4 do
                if bb_key[j] == lualib:KeyName(bb_tb[i]) then
                    if bb_tb[i] == nil then
                        lualib:SetInt(player,"zmws",0)
                    end
                end
            end
            for j=5,7 do
                if bb_key[j] == lualib:KeyName(bb_tb[i]) then
                    if bb_tb[i] == nil then
                        lualib:SetInt(player,"zmgjs",0)
                    end
                end
            end
            for j=8,10 do
                if bb_key[j] == lualib:KeyName(bb_tb[i]) then
                    if bb_tb[i] == nil then
                        lualib:SetInt(player,"zmdx",0)
                    end
                end
            end
        end
    end
    if bb_tb == nil or table.getn(bb_tb) == 0 then
        lualib:SetInt(player,"zmws",0)
        lualib:SetInt(player,"zmgjs",0)
        lualib:SetInt(player,"zmdx",0)
    end
end

function on_pre_catch(player,pet,skill_id)
    local key_name = lualib:KeyName(pet)
    local zmws = lualib:GetInt(player,"zmws")
    local zmgjs = lualib:GetInt(player,"zmgjs")
    local zmdx = lualib:GetInt(player,"zmdx")

    if lualib:HasSkill(player,"诱惑（军势印）",false) then
        if lualib:Player_GetServantCount(player) >= 6 then
            lualib:SysMsg_SendWarnMsg(player,"最多捕捉6只宝宝！")
            return false
        end
    else
        if lualib:Player_GetServantCount(player) >= 5 then
            lualib:SysMsg_SendWarnMsg(player,"最多捕捉5只宝宝！")
            return false
        end
    end


    if lualib:HasSkill(player,"诱惑（噬魂印）",false) then
        for i=1,4 do
            if key_name == bb_key[i] then
                if zmws == 0 then
                    lualib:SetInt(player,"zmws",1)
                    if not lualib:HasTimer(player,123150) then
                        lualib:AddTimer(player,123150,1000,-1,"shanbianl")
                        return true
                    end
                else
                    lualib:SysMsg_SendWarnMsg(player,"同类怪物只能抓一个！")
                    return false
                end
            end
        end
        for i=5,7 do
            if key_name == bb_key[i] then
                if zmgjs == 0 then
                    lualib:SetInt(player,"zmgjs",1)
                    if not lualib:HasTimer(player,123150) then
                        lualib:AddTimer(player,123150,1000,-1,"shanbianl")
                        return true
                    end
                else
                    lualib:SysMsg_SendWarnMsg(player,"同类怪物只能抓一个！")
                    return false
                end
            end
        end
        for i=8,10 do
            if key_name == bb_key[i] then
                if zmdx == 0 then
                    lualib:SetInt(player,"zmdx",1)
                    if not lualib:HasTimer(player,123150) then
                        lualib:AddTimer(player,123150,1000,-1,"shanbianl")
                        return true
                    end
                else
                    lualib:SysMsg_SendWarnMsg(player,"同类怪物只能抓一个！")
                    return false
                end
            end
        end
        for i=1,#bb_key do
            if keyName ~= bb_key[i] then
                return true
            end
        end
    else
        for i=1,#bb_key do
            if key_name == bb_key[i] then
                lualib:SysMsg_SendWarnMsg(player,"能力不足，不可捕捉！")
                return false
            end
        end
        if key_name == "虎卫总管" then
            local servant_t = lualib:Player_GetServantList(player)
            if servant_t ~= nil or table.getn(servant_t) ~= 0 then
                for i=1,#servant_t do
                    if lualib:KeyName(servant_t[i]) == key_name then
                        lualib:SysMsg_SendWarnMsg(player,"您已经有一只同样的随从了！")
                        return false
                    end
                end
            end
        end

        return true
    end
end

function on_servant_betry(pet)
    lualib:Kill(pet)
    return true
end

function on_catch(player, pet, skill_id)
    if lualib:HasSkill(player,"诱惑（血契印）",false) then
        lualib:Player_SetServantLevel(pet,4)
    end
    lualib:AddTimer(pet, 13, baobao_t[2]*1000-5*60, 1, "tishi")
end

function tishi(pet,id)
    if lualib:Monster_IsExist(pet) then
        local master = lualib:Monster_GetMaster(pet)
        if master ~= "" then
            local player = lualib:Name2Guid(master)
            if player ~= "" then
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
                lualib:SysMsg_SendWarnMsg(player,"5分钟后，您的某一只宝宝会叛变死亡，请您注意了！")
            end
        end
    end
end

--[[function panbian(pet, id)
    if lualib:Monster_IsExist(pet) then
        local master = lualib:Monster_GetMaster(pet)
        if master ~= "" then
            local player = lualib:Name2Guid(master)
            if player ~= "" then
                lualib:ServantBetry(player, pet)
            end
        end
    end
end--]]

--[[function siwang(pet, id)
    if lualib:Monster_IsExist(pet) then
        lualib:Kill(pet)
    end
end--]]


function kaiquchuansong()
    local map = lualib:Map_GetMapGuid("开服等待区")
    local mingdan = lualib:Map_GetMapPlayers(map,true)
    for k,v in pairs(mingdan) do
        local x = 377
        local y = 282
        local r_x = lualib:GenRandom(-7, 7)
        local r_y = lualib:GenRandom(-7, 7)
        lualib:Player_MapMoveXY(v, "巫山城", x + r_x, y + r_y, 1)
    end
end
local buff_tb = {
    {"狂暴1",3000},
    {"狂暴2",2000},
    {"狂暴3",3000},
    {"狂暴4",4000},
}

function on_pre_player_die(player,killer)
    if lualib:Player_IsPlayer(killer) then
        for i, v in pairs(buff_tb) do
            if lualib:HasBuff(player,v[1]) then
                --lualib:SysMsg_SendBroadcastMsg(tostring(v[1]), "洪子涵")
                lualib:AddIngot(killer,math.floor(v[2]/2),"杀死神力者","闫旭")
                lualib:DelBuff(player,v[1])
            end
        end
    elseif lualib:Monster_IsMonster(killer) then
        local player_name = lualib:Monster_GetMaster(killer)
        local player_guid = lualib:Name2Guid(player_name)
        if player_name ~= "" then
            local player_guid = lualib:Name2Guid(player_name)
            for i, v in pairs(buff_tb) do
                if lualib:HasBuff(player,v[1]) then
                    --lualib:SysMsg_SendBroadcastMsg(tostring(v[1]), "洪子涵")
                    lualib:AddIngot(player_guid,math.floor(v[2]/2),"杀死神力者","闫旭")
                    lualib:DelBuff(player,v[1])
                end
            end
        end
    end
    lualib:ShowFormWithContent(player, "脚本表单", [[AreYouStupid.CloseStupidWindow()]])
    if lualib:HasTimer(player, 77638) then
        lualib:DisableTimer(player, 77638)
    end
    return true
end


function on_post_die(victim, killer)
    lualib:SetInt(killer, "die_flag", 1)

    --[[if not lualib:Monster_IsMonster(player) then
        lualib:SysMsg_SendBroadcastMsg("玩家#COLORCOLOR_GREENG#「"..lualib:Name(player).."」#COLOREND#被#COLORCOLOR_BLACK#「"..lualib:Name(killer).."」#COLOREND#杀死","千里传音")
    end--]]
    victim_name = lualib:KeyName(victim)
    local kill_ren_name = lualib:Name(killer)
    local victim_ren_name = lualib:Name(victim)

    if lualib:Player_IsPlayer(victim) == true	then
        victim_family_name = lualib:GetFamilyName(victim)
    end

    if 	victim_family_name ~= "" then
        if lualib:Player_IsPlayer(victim) then
            if lualib:Monster_IsMonster(killer) then
                local ownerName = lualib:Monster_GetMaster(killer)
                if ownerName ~= "" then
                    local killnotice1 = "千里传音玩家：#COLORCOLOR_BROWN#["..ownerName.."]#COLORCOLOR_YELLOW#将→→#COLORCOLOR_BROWN#["..victim_ren_name.."]#COLORCOLOR_YELLOW#击杀，强力围观中！！！"
                    lualib:SysMsg_SendBroadcastColor(killnotice1, "", 1, 12)
                else
                    local killnotice1 = "千里传音：#COLORCOLOR_BROWN#["..kill_ren_name.."]#COLORCOLOR_YELLOW#将→→#COLORCOLOR_BROWN#『"..victim_family_name.."』#COLORCOLOR_YELLOW#行会的#COLORCOLOR_BROWN#["..victim_ren_name.."]#COLORCOLOR_YELLOW#击杀，强力围观中！！！"
                    lualib:SysMsg_SendBroadcastColor(killnotice1, "", 1, 12)
                end
            else
                local killnotice1 = "千里传音玩家：#COLORCOLOR_BROWN#["..kill_ren_name.."]#COLORCOLOR_YELLOW#将→→#COLORCOLOR_BROWN#『"..victim_family_name.."』#COLORCOLOR_YELLOW#行会的#COLORCOLOR_BROWN#["..victim_ren_name.."]#COLORCOLOR_YELLOW#击杀，强力围观中！！！"
                lualib:SysMsg_SendBroadcastColor(killnotice1, "", 1, 12)
            end
        end
    else
        if lualib:Player_IsPlayer(victim) then
            if lualib:Monster_IsMonster(killer) then
                local ownerName = lualib:Monster_GetMaster(killer)
                if ownerName ~= "" then
                    local killnotice1 = "千里传音玩家：#COLORCOLOR_BROWN#["..ownerName.."]#COLORCOLOR_YELLOW#将→→#COLORCOLOR_BROWN#["..victim_ren_name.."]#COLORCOLOR_YELLOW#击杀，强力围观中！！！"
                    lualib:SysMsg_SendBroadcastColor(killnotice1, "", 1, 12)
                else
                    local killnotice1 = "千里传音：#COLORCOLOR_BROWN#["..kill_ren_name.."]#COLORCOLOR_YELLOW#将→→#COLORCOLOR_BROWN#["..victim_ren_name.."]#COLORCOLOR_YELLOW#击杀，强力围观中！！！"
                    lualib:SysMsg_SendBroadcastColor(killnotice1, "", 1, 12)
                end
            else
                local killnotice1 = "千里传音玩家：#COLORCOLOR_BROWN#["..kill_ren_name.."]#COLORCOLOR_YELLOW#将→→#COLORCOLOR_BROWN#["..victim_ren_name.."]#COLORCOLOR_YELLOW#击杀，强力围观中！！！"
                lualib:SysMsg_SendBroadcastColor(killnotice1, "", 1, 12)
            end
        end
    end

    ------判断是否为是人物
    if lualib:Player_IsPlayer(killer) then
        --shaguaichufa(killer,victim) --人物杀怪执行
    elseif lualib:Monster_IsMonster(killer) then
        local player_name = lualib:Monster_GetMaster(killer)
        if player_name ~= "" then
            local player_guild = lualib:Name2Guid(player_name)
        end
    end
end

--上马
function on_ride_request(player)
    local buff_table = {"变猪术", "变怪显名"}
    local hashorse = lualib:Attr(player, 200)

    if hashorse == 1 then
        lualib:MsgBox(player, "你已经处于骑乘状态了！")
        return
    end
    --拥有变身BUFF无法骑马
    for i = 1, #buff_table do
        if lualib:HasBuff(player, buff_table[i]) == true then
            lualib:MsgBox(player, "变身状态无法骑马，请右键点击BUFF图标取消BUFF后再进行尝试")
            return
        end
    end
    --上马读条
    lualib:ProgressBarStart(player, 50, "上马中", "on_Horse_true", "on_Horse_false", "")
end

--上马
function on_Horse_true(player)
    lualib:Ride(player)
    return true
end

--上马被打断
function on_Horse_false(player)
    lualib:SysMsg_SendTriggerMsg(player, "上马被打断")
    return true
end


-- 下马
function on_unride_request(player)
    local hashorse = lualib:Attr(player, 200)
    if hashorse == 2 then--
        lualib:MsgBox(player, "你还没有骑乘，不能下马状态了！")
    else
        lualib:UnRide(player)
    end

    return true
end


function on_castle_war_start(castle_name, dst_map_guid, basilica_map_guid)
    local map = lualib:Map_GetMapGuid("龙城")

    lualib:SetInt("0", "war_start", 1)

    if lualib:HasTimer("0",19950414) then
        lualib:DisableTimer("0",19950414)
    end

    for i=1,5 do
        lualib:SysMsg_SendBroadcastColor("[神歌城]攻城战开始了！", "", 1, 12)
    end

    lualib:AddTimerEx(map,11841,1000,-1,"charen",map)
end

function charen(map)
    local ranges = {0, 574, 279, 90, 90}
    local players = lualib:Map_GetRegionPlayersEx(map,ranges,true) --获取玩家GUID列表
    local days = lualib:GetAllDays(0)
    for i,v in ipairs(players) do
        local hanghuis = lualib:GetFamilyName(v)
        if lualib:GetDayInt(v,"jisuanrenshu") == 0 then
            if lualib:GetDBNum(hanghuis..days) == 0 then
                lualib:SetDBStrEx("battleHang",lualib:GetDBStr("battleHang")..hanghuis.."#",6)
                lualib:SetDBNumEx(hanghuis..days,1,6)
                lualib:SetDayInt(v,"jisuanrenshu",1)
            else
                lualib:SetDBNumEx(hanghuis..days,lualib:GetDBNum(hanghuis..days)+1,6)
                lualib:SetDayInt(v,"jisuanrenshu",1)
            end
        end
    end
    local gchh = lualib:StrSplit(lualib:GetDBStr("battleHang"), "#") --攻城行会
    local name = gchh[1]
    local nums = lualib:GetDBNum(gchh[1]..days)
    local winhh = lualib:GetCastleOwnFamily("神歌城")
    for k,v in ipairs(gchh) do
        if v ~= winhh then
            if lualib:GetDBNum(v..days) > nums then
                name = v
                nums = lualib:GetDBNum(v..days)
                lualib:SetDBStrEx("lost",name,6)
            end
        end
    end

end


function on_castle_war_end(castle_name, dst_map_guid, basilica_map_guid)

    local map = lualib:Map_GetMapGuid("龙城")
    lualib:SetInt("0", "war_start", 0)
    for i=1,5 do
        lualib:SysMsg_SendBroadcastColor("[神歌城]攻城战结束了！", "", 1, 12)
    end

    lualib:DisableTimer(map,11841)
end

function on_player_relive(player)
    local cur_map = lualib:MapGuid(player)
    local cur_map_1 = lualib:Map_GetMapGuid("监狱")
    --local cur_map_keyname = lualib:KeyName(cur_map)
    if cur_map_1 == cur_map then
        lualib:Player_MapMove(player,"监狱")
    end
    lualib:SetInt(player, "die_flag", 0)
    local map = lualib:Map_GetMapGuid("龙城")
    if lualib:GetInt("0", "war_start") == 1 then
        local own_family = lualib:GetCastleOwnFamily("神歌城")
        local my_family = lualib:GuildGuid(player)

        if own_family == "" or my_family == "" then
            return true
        else
            if lualib:GetCastleOwnFamily("神歌城")== lualib:Name(my_family) or lualib:GetCastleTempFamily("神歌城") == lualib:Name(my_family) then
                lualib:Player_Relive(player, map, 532, 243, 5, 20)
                return false
            else
                return true
            end
        end
    else
        return true
    end
end

function dynamic_nickname(player)
    local token = "dynamic_nikename_tick"
    local tick = lualib:GetInt(player, token)
    local colors = {"GREENG", "GOLD", "SKYBLUE", "PINK", "MAGENTA", "ORANGE", "PURPLE"}
    local total_color = #colors
    local idx = 1 + tick % total_color
    lualib:Player_SetNameColor(player, colors[idx])
    tick = tick + 1
    if tick >= total_color then
        tick = 0
    end
    lualib:SetInt(player, token, tick)
end

function check_title(player)
    local title_t = {
        {5000000, "王者赞助大使", ""},
        {2000000, "钻石赞助大使", ""}, --需要充值元宝数量+称号名称+名字颜色
        {1000000, "金牌赞助大使", ""},
        {500000, "银牌赞助大使", "GREENG"},
        {200000, "铜牌赞助大使", "BLUE"},
    }
    local compare = {
        ["王者赞助大使"] = 4,
        ["钻石赞助大使"] = 54,--称号名称 = 对应的称号ID
        ["金牌赞助大使"] = 55,
        ["银牌赞助大使"] = 53,
        ["铜牌赞助大使"] = 3,
    }
    local title = nil
    local color = nil
    --local buff = nil
    local id = lualib:UserID(player)
    local define_total = lualib:GetDBNum("define_bill"..id)
    local total = lualib:GetTotalBill(player) + define_total --玩家的充值金额
    for k, v in ipairs(title_t) do
        if total >= v[1] then
            title = v[2]
            color = v[3]
            --buff = v[4]
            break
        end
    end

    if title ~= nil then
        local s = ""
        if lualib:GetInt(player, "qinguoqincheng") > 0 then
            s = s.."倾国倾城\n"
        end
        if lualib:GetInt(player, "renzhengsr") > 0 then
            s = s.."认证商人\n"
        end
        s = s..title.."\n"
        if color == "" then
            if not lualib:HasTimer(player,13406) then
                lualib:AddTimerEx(player,13406,2000,-1,"dynamic_nickname","")
            end
            lualib:AddTitle(player, compare[title])
            return ""
        end
        lualib:SetStr(player, "_tc_", color)
        lualib:NotifyVar(player, "_tc_")
        lualib:AddTitle(player, compare[title])
    else
        local s = ""
        if lualib:GetInt(player, "qinguoqincheng") > 0 then
            s = s.."倾国倾城\n"
        end
        if lualib:GetInt(player, "renzhengsr") > 0 then
            s = s.."认证商人\n"
        end
        lualib:SetStr(player, "_tc_", "")
        lualib:NotifyVar(player, "_tc_")
    end
end

function GuanBi(player)
    return""
end

function panduanzd(player)
    if lualib:Player_HasTeam(player) then
        if lualib:GetInt(player,"初次组队") == 0 then
            lualib:SetInt(player,"初次组队",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【初次组队】成就，可前往领取奖励！", 1500)
        end
    end
end

function naijiu(player,id,item_guid)

    local item = tostring(item_guid)
    local leixing = lualib:Item_GetSubType(player,item)

    if leixing == 20 then
        if lualib:Item_GetDurability(player,item) == 0 then
            if lualib:GetInt(player,"naijiuwei0") == 0 then
                local sxz = lualib:GetInt(item,"_dv60")
                local sxz1 = lualib:GetInt(item,"_dv61")
                local yin_level = lualib:GetInt(item,"yinzhang_level")
                lualib:SetInt(item,"yin_level",yin_level)
                lualib:SetInt(item,"menpai_shuxing2",sxz)
                lualib:SetInt(item,"menpai_shuxing4",sxz1)
                lualib:SetInt(item,"_dv60",0)
                lualib:SetInt(item,"_dv61",0)
                lualib:SetInt(item,"yinzhang_level",0)
                lualib:DisableTimer(player,998001)
                lualib:SetInt(player,"naijiuwei0",1)
                lualib:Item_NotifyUpdate(item)
            end
        else
            local sxz = lualib:GetInt(item,"_dv60")
            local sxz1 = lualib:GetInt(item,"_dv61")
            local yin_level = lualib:GetInt(item,"yinzhang_level")
            lualib:SetInt(item,"yin_level",yin_level)
            lualib:SetInt(item,"menpai_shuxing2",sxz)
            lualib:SetInt(item,"menpai_shuxing4",sxz1)
        end
    end
    return ""
end

function addTimerForNaiJiu(player)
    local item_guid = lualib:Player_GetItemGuid(player,411)
    if item_guid ~= "" then
        if not lualib:HasTimer(player,998001) then
            lualib:AddTimerEx(player,998001,1000,-1,"naijiu",item_guid)
        end
    end
    return ""
end

function on_player_login(player)
    local item_guid = lualib:Player_GetItemGuid(player,411)

    if item_guid ~= "" then
        if not lualib:HasTimer(player,998001) then
            lualib:AddTimerEx(player,998001,1000,-1,"naijiu",item_guid)
        end
    end

    if lualib:GetInt(player,"初次组队") ~= 2 then
        if not lualib:HasTimer(player,1558475) then
            lualib:AddTimer(player,1558475,1000,-1,"panduanzd")
        end
    end
    lualib:Player_SetInvincible(player, false)

    local client_type = lualib:GetClientType(player)
    -- 节日活动
    -- 获取当前时间串
    local timeStr = lualib:Now()
    if lualib:TimeDiff(timeStr, ShareConstant.festival_begin_time) >= 0 and  lualib:TimeDiff(ShareConstant.festival_end_time, timeStr) >= 0 then
        local iconData = ""
        if client_type == 0 then
            iconData = "festivalBeginTime = "..serialize(ShareConstant.festival_begin_time)..";festivalEndTime = "..serialize(ShareConstant.festival_end_time)..";iconData = "..serialize(ShareConstant.festival_pc_icon)..";festival_title = "..serialize(ShareConstant.festival_window_pc_title)..";festival_txt = "..serialize(ShareConstant.festival_window_pc_text)..";festival_version = "..serialize(ShareConstant.festival_window_pc_version)..";festival_iconMagic = "..serialize(ShareConstant.festival_mobile_magic)
        elseif client_type == 2 then
            iconData = "festivalBeginTime = "..serialize(ShareConstant.festival_begin_time)..";festivalEndTime = "..serialize(ShareConstant.festival_end_time)..";iconData = "..serialize(ShareConstant.festival_mobile_icon)..";festival_title = "..serialize(ShareConstant.festival_window_mobile_title)..";festival_txt = "..serialize(ShareConstant.festival_window_mobile_text)..";festival_version = "..serialize(ShareConstant.festival_window_mobile_version)..";festival_iconMagic = "..serialize(ShareConstant.festival_mobile_magic)
        end
        lualib:ShowFormWithContent(player, "脚本表单", iconData)
        lualib:ShowFormWithContent(player, "form文件表单", "节日活动图标")
    end

    check_title(player)
    --获取充值
    local user_id = lualib:UserID(player)
    local cz_num = lualib:GetDBNum("cz_"..user_id)
    if cz_num > 0 then
        lualib:SetDBNumEx("cz_"..user_id,0,4)
        on_trigger_billin(player, cz_num)
    end
    lualib:DelayCall(player, 100, "右上图标:main", "");--右上角图标
    --lualib:DelayCall(player, 1, "行会争霸:check", "");
    local level = lualib:Level(player)
    --[[    for k, v in ipairs(level_buff_t) do
            if level >= v[1] and level <= v[2] then
                lualib:AddBuff(player, v[3], 0)
                break
            end
        end--]]

    local max = lualib:GetDBNum("最高等级")
    if level > max then
        max = level
        lualib:SetDBNumEx("最高等级", level, 2)
    end
    if max >= distace[1] then
        if max - level >= distace[2] then
            lualib:AddBuff(player, distace[3], 0)
        else
            if lualib:HasBuff(player, distace[3]) then
                lualib:DelBuff(player, distace[3])
            end
        end
    end
    lualib:DelayCall(player, 1, "登陆脚本:main", "");
    lualib:DelayCall(player, 1, "魔气血石:on_login", "");
    active_player(player, 2, 0)	--登录时向网站发送角色最新信息，不要删除否则影响统计功能
    --lualib:DelayCall(player, 2000, "client_ver", "");
    lualib:ShowFormWithContent(player, "form文件表单", "服务器时间表单#"..lualib:GetAllTime())
    --lualib:AddTrigger(player, lua_trigger_post_equip, "OnPostEquip");
    --lualib:AddTrigger(player, lua_trigger_post_un_equip, "OnPostUnEquip");

    --死亡上线
    local die_flag = lualib:GetInt(player, "die_flag")
    if lualib:GetInt("0", "war_start") == 1 and die_flag == 1 then
        local own_family = lualib:GetCastleOwnFamily("神歌城")
        local my_family = lualib:GuildGuid(player)
        if own_family == "" or own_family ~= lualib:Name(my_family) then
        else
            lualib:Player_MapMoveXY(player, "龙城", 586, 283, 5)
            lualib:SetInt(player, "die_flag", 0)
        end
    end

    --GM登陆
    if lualib:Player_IsGM(player) then
        lualib:Player_SetGhost(player, true)
        lualib:SysMsg_SendTriggerMsg(player, "你已进入隐身状态！")
        lualib:Player_SetInvincible(player, true)
        lualib:SysMsg_SendTriggerMsg(player, "你已进入无敌状态！")
        lualib:AddBuff(player, "疾驰", 60*60*24)
        lualib:SysMsg_SendTriggerMsg(player, "你已进入疾驰状态！")
        --lualib:AddBuff(player, "被野蛮冲撞3级", 100)
    end

    --月卡
    --[[if lualib:GetInt(player,"MonthlyCardCheck") == 0 then
        lualib:DelayCall(player,1,"月卡表单:openLayout","")
    end
    local IsMonthlyCard = lualib:GetInt(player,"IsMonthlyCard")
    local MonthlyCardDays = lualib:GetInt(player,"MonthlyCardDays")
    local name = lualib:Name(player)
    if MonthlyCardDays <= 0 then
        lualib:SetInt(player,"IsMonthlyCard",0)
    end
    if IsMonthlyCard == 1 then
        if lualib:GetDayInt(player,"MonthlyCardIngot") == 0 then
            lualib:SetDayInt(player,"MonthlyCardIngot",1)
            lualib:SetInt(player,"MonthlyCardDays",MonthlyCardDays-1)
            if lualib:AddIngot(player,800,"月卡每日赠送","月卡") then
                lualib:SysMsg_SendBroadcastMsg(tostring("恭喜["..name.."]获得月卡每日赠送800元宝"), "久玩月卡")
            end
        end
    end
    if MonthlyCardDays <= 0 then
        lualib:SetInt(player,"IsMonthlyCard",0)
    end--]]

    local client_type = lualib:GetClientType(player)
    --右上角图标显示

    Lfte_xianshi(player)		--转盘

    if client_type == 0 then
        kill_ranking_show(player)  --排行榜
    end
    lualib:DelayCall(player, 1, "公告牌:chongzhi_paihang", "")

    --功能导入
    marry_load(player)			--夫妻是否组队/跨天扣除亲密度
    process_master_apprentice_login(player)	--调用师徒登录触发


    local types = lualib:GetClientType(player)  ----获取玩家进入游戏方式，返回0就是通过客户端，1是页游端，2是手游端
    if types == 0 then      ----------如果玩家是通过客户端进入游戏才执行以下检测
    local NowTime = lualib:GetAllTime()
        local subtimer = NowTime - StartServerTime_int

        if subtimer > 86400 then     ----当前时间大于时间24小时才执行以下检测，避免新区玩家体验较差导致流失，自行决定是否需要这个判断
        if lualib:Player_IsGM(player) == false then
            lualib:GetClientCheckInfo(player,  "Client_info", "吃葡萄不吐葡萄皮，仓井思密达，神途大法好！",5000)  ----检测多开，方便GM多开看区，不检测GM的多开数
        end

            if Servertime_int >= ServerNewtime_int then   -----如果当前引擎版本 >= 预设的最新引擎版本才执行MD5检测
            lualib:AddTimer(player,20150501,lualib:GenRandom(300, 600) * 1000,-1,"md5_check")
                ---玩家同时检测MD5会卡，建议设置上线5--10分钟检测一次，同时避免设置固定时间让外挂找到规律
            end
            lualib:DelayCall(player, 3000, "client_ver", "")  ------ 检测客户端版本delaycall 回调
        end
    end



    --lualib:SysMsg_SendBottomColor(player, "加载完毕，祝您游戏愉快", 1, 2)
    --lualib:SysMsg_SendTriggerMsg(player, "开始添加防外挂定时器.....")

    local zoneID = lualib:GetZoneId()
    if zoneID == 577425 or zoneID == 527126 or zoneID == 638933 then
        -- 防外挂定时器
        lualib:SysMsg_SendBottomColor(player, "久玩防外挂系统启动中………………", 1, 2)
        lualib:DelayCall(player, math.random(1, 1500), "sendMsgForDefeatCheat", "一")
        lualib:DelayCall(player, math.random(2001, 3500), "sendMsgForDefeatCheat", "二")
        lualib:DelayCall(player, math.random(4001, 5500), "sendMsgForDefeatCheat", "三")
        lualib:DelayCall(player, math.random(6001, 7500), "sendMsgForDefeatCheat", "四")
        local addSuc = lualib:AddTimer(player, 99031, 60000, -1, "protectPlayerProfitTimer")
        if addSuc then
            --lualib:SysMsg_SendTriggerMsg(player, "防外挂定时器添加成功.....")
        else
            --lualib:SysMsg_SendTriggerMsg(player, "防外挂定时器添加失败.....")
        end
    end

    -- 外挂检测
    --if lualib:HasTimer(player, 10955) then
    --    lualib:DisableTimer(player, 10955)
    --    lualib:AddTimer(player, 10955, 60000, -1, "judgeYourProgram")
    --else
    --    lualib:AddTimer(player, 10955, 60000, -1, "judgeYourProgram")
    --end
    lualib:ShowFormWithContent(player, "脚本表单", "CL:SubmitProcInfo2(\"装备回收表单\", \"getClientProc\", \"\")")
end

function judgeYourProgram(player, idx)
    lualib:ShowFormWithContent(player, "脚本表单", "CL:SubmitProcInfo2(\"装备回收表单\", \"getClientProc\", \"\")")
end

function sendMsgForDefeatCheat(player, param)
    if param == "一" then
        lualib:SysMsg_SendBottomColor(player, "防外挂系统加载中，进度"..math.random(1,20).."%, 请稍等………………", 1, 2)
    elseif param == "二" then
        lualib:SysMsg_SendBottomColor(player, "防外挂系统加载中，进度"..math.random(21,50).."%, 请稍等………………", 1, 2)
    elseif param == "三" then
        lualib:SysMsg_SendBottomColor(player, "防外挂系统加载中，进度"..math.random(51,90).."%, 请稍等………………", 1, 2)
    elseif param == "四" then
        lualib:SysMsg_SendBottomColor(player, "防外挂系统加载中，进度100%，加载完毕，祝您游戏愉快！", 1, 2)
    end
    return
end

-- @Usage: 用于生成随机验证码
-- @Time: 2020/2/21 17:13
-- @Author: Ken
-- @Param: 无
-- @Return: 生成的随机验证码
local codeRandomTable = {"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y", "z"}
function genRandomVertifyCode()
    local code = ""
    local first = codeRandomTable[lualib:GenRandom(1, #codeRandomTable)]
    local second = codeRandomTable[lualib:GenRandom(1, #codeRandomTable)]
    local third = codeRandomTable[lualib:GenRandom(1, #codeRandomTable)]
    code = first..tostring(lualib:GenRandom(1, 100))..second..tostring(lualib:GenRandom(1, 200))..third..tostring(lualib:GenRandom(1, 300))
    return code
end

local otherMap = {
    ["生死之间"] = true,
    ["地牢1层北"] = true,
    ["地牢1层东"] = true,
    ["地牢1层西"] = true,
    ["地牢2层北"] = true,
    ["地牢2层西"] = true,
    ["蜈蚣连接通道1"] = true,
    ["蜈蚣连接通道2"] = true,
    ["蜈蚣连接通道3"] = true,
    ["蜈蚣连接通道4"] = true,
    ["蜈蚣连接通道5"] = true,
    ["幽冥回廊"] = true,
    ["恐怖空间"] = true,
    ["一线天"] = true,
    ["黑暗地带"] = true,
    ["死亡棺材"] = true,
    ["魔王穴二层"] = true,
    ["魔王穴一层"] = true,
    ["魔王穴三层"] = true,
    ["邪恶势力"] = true,
    ["传奇部落"] = true,
    ["幻境2"] = true,
    ["幻境1"] = true,
    ["幻境3"] = true,
    ["幻境4"] = true,
    ["幻境5"] = true,
    ["幻境6"] = true,
    ["幻境7"] = true,
    ["幻境8"] = true,
    ["幻境9"] = true,
    ["幻境10"] = true,
    ["石窟一层"] = true,
    ["石窟二层"] = true,
    ["石窟三层"] = true,
    ["石窟四层"] = true,
    ["石窟五层"] = true,
    ["石窟六层"] = true,
    ["牛洞一层"] = true,
    ["牛洞二层"] = true,
    ["牛洞三层"] = true,
    ["牛洞四层"] = true,
    ["牛洞五层"] = true,
    ["牛洞六层"] = true,
    ["左回廊"] = true,
    ["山谷密道1"] = true,
    ["山谷密道2"] = true,
    ["右回廊"] = true,
    ["魔月峡谷广场"] = true,
    ["魔月峡谷北"] = true,
    ["魔月峡谷南"] = true,
    ["废矿入口"] = true,
    ["尸王殿"] = true,
    ["魔月峡谷东"] = true,

}

-- @Usage: 用于防止玩家使用脚本挂机，定时检测地图刷怪弹验证
-- @Time: 2020/2/21 16:38
-- @Author: Ken
-- @Param1: player : GUIDType
-- @Param2: timerid : 定时器id
-- @Return: 无
function protectPlayerProfitTimer(player, timerid)
    local timeInMap = lualib:GetInt(player, "timeInMap")

    if timeInMap + 1 >= math.random(30, 60) then
        local mapKeyName = lualib:KeyName(lualib:MapGuid(player))
        if otherMap[mapKeyName] then
            if not lualib:HasBuff(player, "挂机掉落") then
                -- 目前仅适用于端游
                if lualib:GetClientType(player) == 0 then
                    lualib:DelayCall(player, 1, "防外挂验证表单:start", "")
                end
                lualib:SetInt(player, "timeInMap", 0)
            end
        else
            lualib:SetInt(player, "timeInMap", 0)
            --lualib:SysMsg_SendTriggerMsg(player, "这地图没事的啦")
        end

    else
        --lualib:SysMsg_SendTriggerMsg(player, "恭喜你，喜加1啦")
        if not lualib:HasBuff(player, "挂机掉落") then
            lualib:SetInt(player, "timeInMap", timeInMap + 1)
        end
    end

end

function on_login_delay_timer(player, timer_id)
    local caller = (lualib:Gender(player) == 1) and "丈夫" or "妻子"
    local spouse = lualib:Player_GetCustomVarStr(player, "配偶GUID")
    lualib:SysPromptMsg(spouse, "你的"..caller.."上线了。")
end

function client_ver(player)
    lualib:RequestClientVer(player);

    lualib:DelayCall(player, lualib:GenRandom(2, 5) * 1000, "client_ver_ex", "");
end

function client_ver_ex(player)
    local ver = lualib:GetClientVerEx(player);

    --if (ver < 3003) or (ver <  lualib:GetGSClientVer()) then
    if (ver < 3003) or (ver <  3011 ) then
        lualib:SysMsg_SendTriggerMsg(player, "客户端太老请关闭所有游戏窗口不要双开，重新打开登录器更新！")
        lualib:SysMsg_SendTriggerMsg(player, "客户端太老请关闭所有游戏窗口不要双开，重新打开登录器更新！")
        lualib:SysMsg_SendTriggerMsg(player, "客户端太老请关闭所有游戏窗口不要双开，重新打开登录器更新！")
        lualib:SysMsg_SendTriggerMsg(player, "如果不更新请点击登录器上资源修复完整修复后才可以正常游戏！")
        lualib:SysMsg_SendTriggerMsg(player, "如果不更新请点击登录器上资源修复完整修复后才可以正常游戏！")

        lualib:DelayCall(player, 3000, "kick_player", "");
    end
end

function kick_player(player)
    lualib:Player_Kick(player)
end

function on_player_logout(player)
    if lualib:HasTimer(player,1558475) then
        lualib:DisableTimer(player,1558475)
    end

    if lualib:HasTimer(player,998001) then
        lualib:DisableTimer(player,998001)
    end

    if lualib:HasTimer(player,123150) then
        lualib:SetInt(player,"zmws",0)
        lualib:SetInt(player,"zmgjs",0)
        lualib:SetInt(player,"zmdx",0)
        lualib:DisableTimer(player,123150)
    end
    if lualib:HasTimer(player,2015) then
        lualib:DisableTimer(player,2015)
    end
    lualib:StopAutoRun(player)
    lualib:SetInt(player, "autoattack", 0)
    if lualib:HasTimer(player,999112) then
        lualib:DisableTimer(player,999112)
    end
    lualib:DelayCall(player, 1, "退出脚本:main", "");
    online_gift_logout(player)						--在线礼包退出
end

function on_player_add_exp(player, expv)
    lualib:DelayCall(player, 1, "经验脚本:main", tostring(expv));
    process_horse_add_exp(player, tonumber(expv))
end

function on_level_up(player, level)

    if lualib:GetInt(player,"第一次升级") == 0 then
        lualib:SetInt(player,"第一次升级",1)
        lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【第一次升级】成就，可前往领取奖励！", 1500)
    end
    if level == 10 then
        if lualib:GetInt(player,"达到十级") == 0 then
            lualib:SetInt(player,"达到十级",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【达到十级】成就，可前往领取奖励！", 1500)
        end
    end
    if level == 20 then
        if lualib:GetInt(player,"达到二十级") == 0 then
            lualib:SetInt(player,"达到二十级",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【达到二十级】成就，可前往领取奖励！", 1500)
        end
    end
    if level == 30 then
        if lualib:GetInt(player,"达到三十级") == 0 then
            lualib:SetInt(player,"达到三十级",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【达到三十级】成就，可前往领取奖励！", 1500)
        end
    end
    if level == 35 then
        if lualib:GetInt(player,"达到三十五级") == 0 then
            lualib:SetInt(player,"达到三十五级",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【达到三十五级】成就，可前往领取奖励！", 1500)
        end
    end
    if level == 40 then
        if lualib:GetInt(player,"达到四十级") == 0 then
            lualib:SetInt(player,"达到四十级",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【达到四十级】成就，可前往领取奖励！", 1500)
        end
    end


    local map = lualib:Map_GetMapGuid("巫山城")
    local npc = lualib:Map_GetMapNpc(map,"门派系统")
    if level == 20 then
        lualib:DelayCall(npc,1,"门派系统:main",player)
    end
    local max = lualib:GetDBNum("最高等级")
    if level > max then
        max = level
        lualib:SetDBNumEx("最高等级", level, 2)
    end
    if max >= distace[1] then
        if max - level >= distace[2] then
            lualib:AddBuff(player, distace[3], 0)
        else
            if lualib:HasBuff(player, distace[3]) then
                lualib:DelBuff(player, distace[3])
            end
        end
    end
    local job = lualib:Job(player)
    local account = lualib:AccountName(player)
    local name = lualib:Name(player)
    --50级
    if lualib:GetDBNum("50_zhanshi") < 3 then
        if job == 1 and level == 50 then
            lualib:SetDBNumEx("50_zhanshi",lualib:GetDBNum("50_zhanshi")+1,4)
            lualib:SetDBNumEx("50renshu#"..account.."#"..name.."#"..job,1,0)
        end
    end
    if lualib:GetDBNum("50_fashi") < 3 then
        if job == 2 and level == 50 then
            lualib:SetDBNumEx("50_fashi",lualib:GetDBNum("50_fashi")+1,4)
            lualib:SetDBNumEx("50renshu#"..account.."#"..name.."#"..job,1,0)
        end
    end
    if lualib:GetDBNum("50_daoshi") < 3 then
        if job == 3 and level == 50 then
            lualib:SetDBNumEx("50_daoshi",lualib:GetDBNum("50_daoshi")+1,4)
            lualib:SetDBNumEx("50renshu#"..account.."#"..name.."#"..job,1,0)
        end
    end
    --55级
    if lualib:GetDBNum("55_zhanshi") < 3 then
        if job == 1 and level == 55 then
            lualib:SetDBNumEx("55_zhanshi",lualib:GetDBNum("55_zhanshi")+1,4)
            lualib:SetDBNumEx("55renshu#"..account.."#"..name.."#"..job,1,0)
        end
    end
    if lualib:GetDBNum("55_fashi") < 3 then
        if job == 2 and level == 55 then
            lualib:SetDBNumEx("55_fashi",lualib:GetDBNum("55_fashi")+1,4)
            lualib:SetDBNumEx("55renshu#"..account.."#"..name.."#"..job,1,0)
        end
    end
    if lualib:GetDBNum("55_daoshi") < 3 then
        if job == 3 and level == 55 then
            lualib:SetDBNumEx("55_daoshi",lualib:GetDBNum("55_daoshi")+1,4)
            lualib:SetDBNumEx("55renshu#"..account.."#"..name.."#"..job,1,0)
        end
    end

    --记录测试奖励[添加到升级触发]
    level = tonumber(level)
    local testtime = lualib:GetConstVar("TestServerTime")
    local testtimes = lualib:Str2Time(testtime)
    --local testtimes = lualib:Str2Time("2020-02-27 12:30:00")
    local nowtime = lualib:GetAllTime()
    if nowtime < testtimes then
        local leveluptb = {
            [40] = "levelup40.txt",--等级对应的存储文档名
            [45] = "levelup45.txt",--等级对应的存储文档名
            [48] = "levelup48.txt",--等级对应的存储文档名
            [50] = "levelup50.txt",--等级对应的存储文档名
            [52] = "levelup52.txt",--等级对应的存储文档名
        }
        if leveluptb[level] ~= nil then
            local account = lualib:AccountName(player)
            if not lualib:IO_FileExists(leveluptb[level]) then
                lualib:IO_CreateTextFile(leveluptb[level], false)
            end
            if not lualib:IO_TextFileInsertLine(leveluptb[level], 1, account) then
                lualib:Error("添加公测奖励帐号"..account.."失败！")
            else
                lualib:SysTriggerMsg(player, "恭喜您在内测区升到"..level.."级，正式开区后可领取公测奖励！")
            end
        end
    end

    active_player(player, 3, 0)	--升级时向网站发送角色最新信息，不要删除否则影响统计功能
    process_apprentice_level_up(player, level)			--调用徒弟升级触发
end



--------[[玩家第一次进入游戏]]
function on_first_in_game(player)
    local level = lualib:Level(player)
    local job = lualib:Job(player)
    local testtime = lualib:GetConstVar("TestServerTime")
    local opentime = lualib:GetConstVar("StartServerTime")
    local item_k = {"新手1级礼包", "木剑","新手指南"}
    local item_n = {1, 1, 1}
    local item_b = {1, 1, 1}
    local item_o = {0, 0, 0}
    local Gender = lualib:Gender(player)
    local award_item = {"布衣(男)", "布衣(女)"}

    if lualib:GetAllTime() <= lualib:Str2Time(testtime)  then
        if not lualib:Player_ItemRequest(player, item_k, item_n, item_b, item_o, "给物品：第一次进游戏", "") then
            lualib:SysMsg_SendTriggerMsg(player, "新手物品赠送失败！")
        end

        if not lualib:AddItem(player, award_item[Gender], 1, true, "", "") then
            lualib:SysMsg_SendTriggerMsg(player, "赠送布衣失败！")
        end

        lualib:AddItem(player,"沃玛礼包",1,true,"测试福利","测试福利")
        lualib:AddItem(player,"祖犸礼包",1,true,"测试福利","测试福利")
        for i=1,#skill_tb[job] do
            lualib:AddSkill(player,skill_tb[job][i])
        end
        lualib:Player_MapMoveXY(player, "巫山城", 379, 284, 1)
        local s = "尊敬的玩家：您好！《".. lualib:GetZoneName() .."》服务器，现在处于删档测试期间，游戏将于"..testtime.."正式关闭内测，敬请期待！"
        lualib:SysMsg_SendBottomColor(player, s, 7, 2)
        --测试结束了，游戏还没开区
    elseif lualib:GetAllTime() < lualib:Str2Time(opentime)  then
        if not lualib:Player_IsGM(player) then
            if not lualib:Player_ItemRequest(player, item_k, item_n, item_b, item_o, "给物品：第一次进游戏", "") then
                lualib:SysMsg_SendTriggerMsg(player, "新手物品赠送失败！")
            end

            if not lualib:AddItem(player, award_item[Gender], 1, true, "", "") then
                lualib:SysMsg_SendTriggerMsg(player, "赠送布衣失败！")
            end
            lualib:Player_MapMoveXY(player, "开服等待区", 30, 30, 10)
            local s = "尊敬的玩家：您好！《".. lualib:GetZoneName() .."》服务器正在筹备阶段，无法登陆，游戏将于"..opentime.."正式开启，敬请期待！"
            lualib:SysMsg_SendBottomColor(player, s, 7, 2)
        end
    else
        if not lualib:Player_ItemRequest(player, item_k, item_n, item_b, item_o, "给物品：第一次进游戏", "") then
            lualib:SysMsg_SendTriggerMsg(player, "新手物品赠送失败！")
        end

        if not lualib:AddItem(player, award_item[Gender], 1, true, "", "") then
            lualib:SysMsg_SendTriggerMsg(player, "赠送布衣失败！")
        end
    end



    local player_name = lualib:Name(player)
    lualib:SysMsg_SendBroadcastMsg("玩家【"..player_name.."】加入游戏,为《久玩神途》添加一份力量。", "[系统提示]")
end


function on_gp(player, gp_runtime, gp, diff_avg_tick)
    local count = lualib:GetTempInt(player, "SetNetCheck");
    if count <= 0  then
        --第一次触发, 给玩家加上严格模式
        lualib:SetTempInt(player, "SetNetCheck", 1);
        lualib:SetNetCheckEx(player, true, true);
        lualib:DelayCall(player, 1200 * 1000, "CancelCheck", "");
    elseif count == 1 then
        --严格模式下, 第二次触发, 给玩家发送警告
        lualib:SetTempInt(player, "SetNetCheck", 2);
        lualib:SysWarnMsg(player, "系统检测到你使用非法外挂，请立即停止使用，否则将对你采取惩罚措施！");
    else
        --严格模式下, 第三次触发, 直接T下线
        lualib:KickByName(lualib:Name(player), 2, "使用外挂");
    end
end

function CancelCheck(player)
    lualib:SetTempInt(player, "SetNetCheck", 0)
    lualib:SetNetCheck(player, false)
end

--上报角色信息
function active_player(player, request_type, times)
    if times >= 3 then
        return;
    end


    local role_up_webDB = lualib:GetTempInt(player, "role_up_webDB") + 600
    local cur_times = lualib:GetAllTime()
    if role_up_webDB > cur_times then
        return;
    end
    local accountid = lualib:Player_GetAccountID(player)
    local account_name = lualib:AccountName(player)
    local serverid = lualib:GetZoneId()
    local role_name = lualib:Name(player);
    local level = lualib:Level(player);
    local job = lualib:Job(player);

    local url = string.format("http://api.hzyotoy.com:8800/api/putroleinfo.do?type=%d&zoneid=%d&userid=%d&role_guid=%s&level=%d&role_name=%s&job=%d"
    ,request_type, serverid, accountid, player, level, lualib:UrlEncode(role_name), job);

    if request_type == nil  or account_name == "" or serverid == 0 then
        return
    else
        if request_type == 3 and level < 20 then
            return
        end


        lualib:SetTempInt(player, "role_up_webDB", cur_times)
        if request_type == 2 then
            if times == 0 then
                lualib:GetURL(url, "do_nothing", player.."#".."0"..request_type, 30)
            elseif times == 1 then
                lualib:GetURL(url, "do_nothing", player.."#".. times ..request_type, 30)
            end
        elseif request_type == 3 then
            if times == 0 then
                lualib:GetURL(url, "do_nothing", player.."#".."0"..request_type, 30)
            elseif times == 1 then
                lualib:GetURL(url, "do_nothing", player.."#".. times ..request_type, 30)
            end
        end
    end
end

--上报角色信息回调
function do_nothing(param, errcode, result)
    local param_t = string.split(param, "#")
    local player = param_t[1]
    local times = tonumber(param_t[2])
    local request_type = tonumber(param_t[3])

    if tonumber(errcode) ~= 0 or result == nil then
        active_player(player, request_type, times + 1)
        return
    end
end


function on_hack_check(player, a, b)
    if b > 10 then
        lualib:SysWarnMsg(player, "请不要使用外挂,你已经被系统记录，情节严重者直接封号！");
        lualib:Error(lualib:Name(player) .. "可能使用挂机外挂");
    end
end


------------------检测外挂回调--------------------
function on_hack_check2(player, C1, C2, C3, C4, C5, C6)
    local types = lualib:GetClientType(player)  ----获取玩家进入游戏方式，返回0就是通过客户端，1是页游端，2是手游端
    if types ~= 0 then      ----------如果不是通过客户端进入游戏，就不执行检测
    return
    end

    local PreTime = lualib:GetTempInt(player, "HackCheckTime")
    local NowTime = lualib:GetAllTime()
    if NowTime - PreTime < 60 then  ----如果当前时间和上次检测时间小于60秒，不执行判断
    return;
    end
    lualib:SetTempInt(player, "HackCheckTime", NowTime)

    -- if C1 >= 1 or C6 >= 1 then    -----C6会误判LOL盒子，慎用！！
    if C1 >= 1 then
        lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
        lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
        lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
        lualib:DelayCall(player, 3000, "kick_player", "")
    end
end

function on_trigger_billin(player, yb)

    yb = tonumber(yb)
    check_title(player)
    local name = lualib:Name(player)
    if not lualib:IO_FileExists("老友回归.txt") then
        lualib:SysMsg_SendBroadcastMsg(tostring(yb), "yb")
        lualib:IO_CreateTextFile("老友回归.txt", false)
    end
    local tb = lualib:IO_GetFileText("老友回归.txt")
    for i,v in pairs(tb) do
        local ttb = string.split(v,"#")
        local account = ttb[1]
        local num = tonumber(ttb[2])
        if lualib:AccountName(player) == account then
            if num > 0 then
                local nums = math.floor(yb*0.1)
                --num = num - nums
                if not lualib:MailToPlayer("老友回归",player,"老友回归奖励",0,nums,{"金币1", tonumber(1), tonumber(1)}) then
                    lualib:MsgBox(player,"发送邮件失败!")
                end
                lualib:IO_TextFileDeleteLineStr("老友回归.txt",""..account.."#"..num)
                num = num - nums
                lualib:IO_TextFileInsertLine("老友回归.txt",1,""..account.."#"..num)
            end
        end
    end
    lualib:DelayCall(player, 300, "leap", "")
    lualib:SysMsg_SendWarnMsg(player, "你充值了"..yb.."元宝")
    lualib:SysMsg_SendBroadcastColor("恭喜玩家“"..name.."”在线充值获得" .. yb ..  "元宝","[充值提示]", 2, 12)
    lualib:DelayCall(player, 1, "公告牌:chongzhi_paihang", "")
end

function on_billinex(user_id, yb)
    local cz_num = lualib:GetDBNum("cz_"..user_id)
    local define_total = lualib:GetDBNum("chongzhi_lb"..user_id)
    lualib:SetDBNumEx("chongzhi_lb"..user_id,define_total+yb,4)
    lualib:SetDBNumEx("cz_"..user_id,cz_num+yb,4)
    -- 节日活动充值
    local timeStr = lualib:Now()
    if lualib:TimeDiff(timeStr, ShareConstant.festival_begin_time) >= 0 and lualib:TimeDiff(ShareConstant.festival_end_time, timeStr) >= 0 then
        local now_yb = lualib:GetDBNum(ShareConstant.festival_bill_variable..tostring(user_id))
        lualib:SetDBNumEx(ShareConstant.festival_bill_variable..tostring(user_id), now_yb+yb, 4)
    end
    lualib:GSRunScript("check_userid", user_id.."#"..yb)

    on_billinax(user_id,yb)
end

function check_userid(player,userid,yb)
    local user_id = lualib:UserID(player)
    if user_id == tonumber(userid) then
        lualib:SetDBNumEx("cz_"..user_id,0,4)
    end
    return ""
end

function on_kill(killer, player)
    --杀人排行榜

    if lualib:Player_IsPlayer(killer) and lualib:Player_IsPlayer(player) then --and lualib:Player_IsGM(killer) == false then
        kill_ranking_func(killer, player)
    end

    if lualib:GUIDType(killer) == 2 and lualib:Monster_GetMaster(killer) ~= "" then
        killer = lualib:Name2Guid(lualib:Monster_GetMaster(killer))
    end
    local player_lv = lualib:Level(player)
    local killer_lv = lualib:Level(killer)
    local level = killer_lv >= 40 and player_lv >= 35
    local req = lualib:GUIDType(player) == 0 and lualib:GUIDType(killer) == 0
    if req == true and level == true then
        if killer_lv - player_lv < 5 then
            lualib:SetInt(player,"sharenshu", lualib:GetInt(killer,"sharenshu")-1) --杀小号杀戮值-1


            local kill = 0
            kill = lualib:GetInt(killer,"sharenshu")
            --lualib:SysMsg_SendBroadcastMsg(tostring(kill),"no.1")
            if kill >= 7 then
                lualib:SetInt(killer,"sharenshu",kill)
                local str = "yin =".."\"杀"..kill.."\""
                lualib:ShowFormWithContent(killer, "脚本表单", str)
                lualib:ShowFormWithContent(killer, "form文件表单", "音频")
                if player ~= "" then
                    local str = "yin =".."\"被杀\""
                    lualib:ShowFormWithContent(player, "脚本表单", str)
                    lualib:ShowFormWithContent(player, "form文件表单", "音频")
                end
            else
                --lualib:SysMsg_SendBroadcastMsg(tostring(kill),"")
                lualib:SetInt(killer,"sharenshu",kill + 1)
                for i =1, 7 do
                    if kill +1 == i then
                        --lualib:SetInt(killer,"sharenshu",kill)
                        local str = "yin =".."\"杀"..i.."\""
                        lualib:ShowFormWithContent(killer, "脚本表单", str)
                        lualib:ShowFormWithContent(killer, "form文件表单", "音频")
                        if player ~= "" then
                            local str = "yin =".."\"被杀\""
                            lualib:ShowFormWithContent(player, "脚本表单", str)
                            lualib:ShowFormWithContent(player, "form文件表单", "音频")
                        end
                        break
                    end
                end
            end
        end
    end
end

function kill_ranking_func(killer, player)--杀人榜需要
    local killer_level = lualib:Level(killer)
    local victim_level = lualib:Level(player)
    local victim_guid = lualib:GetStr(killer, "victim_guid")
    local x = lualib:X(player)
    local y = lualib:Y(player)
    local map = lualib:MapGuid(player)
    if victim_guid == player then
        --[[		lualib:SysMsg_SendBroadcastMsg("","1")
                lualib:RunClientScript(map, "ItemEffect", "texiao", "306300000".."#"..x.."#"..y.."#0#9999999");--]]
        return
    end


    if killer_level >= 35 and killer_level - victim_level <= 5 then
        local week_kill_num = lualib:GetWeekInt(killer, "week_kill_num") + 1
        lualib:SetWeekInt(killer, "week_kill_num", week_kill_num)
        lualib:SetStr(killer, "victim_guid", player)
        local kill_ranking_t = lualib:GetDBStr("kill_ranking_t")

        local kill_name = lualib:Name(killer)
        if kill_ranking_t == "" then
            kill_ranking_t = {}
            kill_ranking_t[1] = {week_kill_num, kill_name}
            lualib:SetDBStrEx("kill_ranking_t", serialize(kill_ranking_t), 6)
        else
            kill_ranking_t = deserialize(kill_ranking_t)

            local is_ranking = false
            for i = 1, #kill_ranking_t do
                if kill_name == kill_ranking_t[i][2] then
                    kill_ranking_t[i][1] = week_kill_num
                    is_ranking = true
                end
            end
            if is_ranking == false then
                if #kill_ranking_t < 10 then
                    kill_ranking_t[#kill_ranking_t + 1] = {week_kill_num, kill_name}
                else
                    kill_ranking_t[11] = {week_kill_num, kill_name}
                end
            end
            table.sort(kill_ranking_t,function(v1,v2)return v1[1] > v2[1] end)
            kill_ranking_t[11] = nil
            lualib:SetDBStrEx("kill_ranking_t", serialize(kill_ranking_t), 6)
        end
    end
end

----------------检查客户端版本------------
function client_ver(player)
    lualib:RequestClientVer(player)  ----请求客户端版本号（玩家刚上线客户端可能没有上报版本号，所以需要主动请求一次）
    lualib:DelayCall(player, lualib:GenRandom(2, 5) * 1000, "client_ver_ex", "")
end


function client_ver_ex(player)
    local ver = lualib:GetClientVerEx(player) ----获得玩家客户端版本号

    --if ver < lualib:GetGSClientVer()  then  ----  获得的客户端版本号和 引擎自动学习到的最新版本号 做比较 （用自己OSS更新资源的需要同步下官方5月13日资源）
    if ver < 3011  then
        --[[  lualib:SysMsg_SendTriggerMsg(player, "你的客户端过老，请关闭游戏重新打开登录器点击[资源修复]更新最新客户端！")
          lualib:SysMsg_SendTriggerMsg(player, "你的客户端过老，请关闭游戏重新打开登录器点击[资源修复]更新最新客户端！")
          lualib:SysMsg_SendTriggerMsg(player, "你的客户端过老，请关闭游戏重新打开登录器点击[资源修复]更新最新客户端！")
          lualib:SysMsg_SendTriggerMsg(player, "你的客户端过老，请关闭游戏重新打开登录器点击[资源修复]更新最新客户端！")
          lualib:SysMsg_SendTriggerMsg(player, "你的客户端过老，请关闭游戏重新打开登录器点击[资源修复]更新最新客户端！")--]]
        lualib:DelayCall(player, 3000, "kick_player", "")
    end
end


--------------检测多开----------------------
function Client_info(player, param, info_table, is_timeout)

    if is_timeout == true then
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:DelayCall(player, 3000, "kick_player", "")
        return;
    end

    if #info_table > 0 then
        if info_table[3] > 3 and info_table[3] ~= 255 then    ---- info_table[3]  表示电脑总共所开神途客户端数
        lualib:SysMsg_SendTriggerMsg(player, "检测到您的电脑已经有3个神途客户端在运行，您不能再开启更多！")
            lualib:SysMsg_SendTriggerMsg(player, "检测到您的电脑已经有3个神途客户端在运行，您不能再开启更多！")
            lualib:SysMsg_SendTriggerMsg(player, "检测到您的电脑已经有3个神途客户端在运行，您不能再开启更多！")
            lualib:SysMsg_SendTriggerMsg(player, "检测到您的电脑已经有3个神途客户端在运行，您不能再开启更多！")
            lualib:SysMsg_SendTriggerMsg(player, "检测到您的电脑已经有3个神途客户端在运行，您不能再开启更多！")
            lualib:DelayCall(player, 3000, "kick_player", "")
            return;
        end
    else
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:SysMsg_SendTriggerMsg(player, "检测多开程序出错，请重新打开登录器，点击[资源修复]后重新登录")
        lualib:DelayCall(player, 3000, "kick_player", "")
        return;
    end
end

----------------检查外挂MD5回调------------

function md5_check(player,timer_id)
    lualib:SetMD5CheckList(player, md5_list, "on_md5_check", "吃葡萄不吐葡萄皮，仓井思密达，神途大法好！", 300000)
end

function on_md5_check(player, param, md5_num_list, is_timeout)

    if is_timeout == true then
        --[[ lualib:SysMsg_SendTriggerMsg(player, "检测外挂程序超时，请重新打开登录器，点击[资源修复]后重新登录")
         lualib:SysMsg_SendTriggerMsg(player, "检测外挂程序超时，请重新打开登录器，点击[资源修复]后重新登录")
         lualib:SysMsg_SendTriggerMsg(player, "检测外挂程序超时，请重新打开登录器，点击[资源修复]后重新登录")
         lualib:SysMsg_SendTriggerMsg(player, "检测外挂程序超时，请重新打开登录器，点击[资源修复]后重新登录")
         lualib:SysMsg_SendTriggerMsg(player, "检测外挂程序超时，请重新打开登录器，点击[资源修复]后重新登录")--]]
        --lualib:DelayCall(player, 3000, "kick_player", "")
    else
        for i = 1,#md5_num_list do
            if md5_num_list[i] > 0 then
                lualib:DelayCall(player, 1, "外挂传送:fwg", "")
                lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
                lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
                lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
                lualib:SysMsg_SendWarnMsg(player, "警告：系统怀疑你可能在使用非法外挂程序，将被踢下线！")
                lualib:Error(lualib:Name(player) .. "可能使用挂机外挂")
            end
        end
    end
end


-------------踢人---------------------
function kick_player(player)
    lualib:Player_Kick(player)
end

--离线挂机
function on_pre_logout(player, exit_type)

    local mapGuid = lualib:MapGuid(player)
    local map = lualib:Name(mapGuid)

    if map == "监狱" then
        lualib:SetInt(player,"lxjy",1)

    end

    lualib:SetInt(player, "autoattack", 0)
    if lualib:HasTimer(player,999112) then
        lualib:DisableTimer(player,999112)
    end

    if lualib:HasTimer(player,998001) then
        lualib:DisableTimer(player,998001)
    end
    if lualib:HasBuff(player,"挂机掉落") then
        lualib:DelBuff(player,"挂机掉落")
    end
    -- 获取当前时间串
    local timeStr = lualib:Now()
    if lualib:TimeDiff(timeStr, ShareConstant.festival_begin_time) >= 0 and  lualib:TimeDiff(ShareConstant.festival_end_time, timeStr) >= 0 then

    else
        local id = tostring(lualib:UserID(player))		--取得玩家的帐号ID.
        lualib:SetDBNumEx(ShareConstant.festival_bill_variable..id, 0, 1)
        lualib:ShowFormWithContent(player, "脚本表单", [[festivalIcon.endCampagin()]])
    end
    if lualib:HasBuff(player,"摆摊") then
        lualib:SetOffline(player, 3600 * 480)
        return false
    end
    local map_keyname = lualib:KeyName(lualib:MapGuid(player))
    if map_keyname == "巫山城" then
        local sjx = lualib:GenRandom(-6, 6)
        local sjy = lualib:GenRandom(-6, 6)
        lualib:Player_MapMoveXY(player,"巫山城", 377 + sjx , 283 + sjy , 1)
        lualib:SetOffline(player, 3600 * 480)
        return false
    elseif map_keyname == "龙城" then
        local sjx = lualib:GenRandom(-9, 9)
        local sjy = lualib:GenRandom(-9, 9)
        lualib:Player_MapMoveXY(player,"龙城", 293 + sjx , 362 + sjy , 1)
        lualib:SetOffline(player, 3600 * 480)
        return false
    elseif map_keyname == "开服等待区" then
        local sjx = lualib:GenRandom(-10, 10)
        local sjy = lualib:GenRandom(-10, 10)
        lualib:Player_MapMoveXY(player, "开服等待区", 26 + sjx , 29 + sjy , 1)
        lualib:SetOffline(player, 3600 * 480)
        return false
    else
        return true
    end


    return true
end

local bb_sx =
{
    {"召唤骷髅1级","龙玟剑","BB加成"},
    {"召唤骷髅2级","龙玟剑","BB加成"},
    {"召唤骷髅3级","龙玟剑","BB加成"},
    {"召唤骷髅4级","龙玟剑","BB加成"},
    {"召唤神兽1级","龙玟剑","BB加成"},
    {"召唤神兽2级","龙玟剑","BB加成"},
    {"召唤神兽3级","龙玟剑","BB加成"},
    {"召唤神兽4级","龙玟剑","BB加成"},
    {"骷髅（射手印）","龙玟剑","BB加成"},
    {"骷髅（战将印）","龙玟剑","BB加成"},
    {"骷髅（帝王印）","龙玟剑","BB加成"},
    {"神兽（圣兽印）","龙玟剑","BB加成"},
    {"神兽（血兽印）","龙玟剑","BB加成"},
    {"神兽（天神印）","龙玟剑","BB加成"},
    {"召唤骷髅1级","逍遥羽扇","BB加成1"},
    {"召唤骷髅2级","逍遥羽扇","BB加成1"},
    {"召唤骷髅3级","逍遥羽扇","BB加成1"},
    {"召唤骷髅4级","逍遥羽扇","BB加成1"},
    {"召唤神兽1级","逍遥羽扇","BB加成1"},
    {"召唤神兽2级","逍遥羽扇","BB加成1"},
    {"召唤神兽3级","逍遥羽扇","BB加成1"},
    {"召唤神兽4级","逍遥羽扇","BB加成1"},
    {"骷髅（射手印）","逍遥羽扇","BB加成1"},
    {"骷髅（战将印）","逍遥羽扇","BB加成1"},
    {"骷髅（帝王印）","逍遥羽扇","BB加成1"},
    {"神兽（圣兽印）","逍遥羽扇","BB加成1"},
    {"神兽（血兽印）","逍遥羽扇","BB加成1"},
    {"神兽（天神印）","逍遥羽扇","BB加成1"},
    {"召唤骷髅1级","六道轮回拂","BB加成2"},
    {"召唤骷髅2级","六道轮回拂","BB加成2"},
    {"召唤骷髅3级","六道轮回拂","BB加成2"},
    {"召唤骷髅4级","六道轮回拂","BB加成2"},
    {"召唤神兽1级","六道轮回拂","BB加成2"},
    {"召唤神兽2级","六道轮回拂","BB加成2"},
    {"召唤神兽3级","六道轮回拂","BB加成2"},
    {"召唤神兽4级","六道轮回拂","BB加成2"},
    {"骷髅（射手印）","六道轮回拂","BB加成2"},
    {"骷髅（战将印）","六道轮回拂","BB加成2"},
    {"骷髅（帝王印）","六道轮回拂","BB加成2"},
    {"神兽（圣兽印）","六道轮回拂","BB加成2"},
    {"神兽（血兽印）","六道轮回拂","BB加成2"},
    {"神兽（天神印）","六道轮回拂","BB加成2"},
    {"召唤骷髅1级","火冥宝剑","BB加成3"},
    {"召唤骷髅2级","火冥宝剑","BB加成3"},
    {"召唤骷髅3级","火冥宝剑","BB加成3"},
    {"召唤骷髅4级","火冥宝剑","BB加成3"},
    {"召唤神兽1级","火冥宝剑","BB加成3"},
    {"召唤神兽2级","火冥宝剑","BB加成3"},
    {"召唤神兽3级","火冥宝剑","BB加成3"},
    {"召唤神兽4级","火冥宝剑","BB加成3"},
    {"骷髅（射手印）","火冥宝剑","BB加成3"},
    {"骷髅（战将印）","火冥宝剑","BB加成3"},
    {"骷髅（帝王印）","火冥宝剑","BB加成3"},
    {"神兽（圣兽印）","火冥宝剑","BB加成3"},
    {"神兽（血兽印）","火冥宝剑","BB加成3"},
    {"神兽（天神印）","火冥宝剑","BB加成3"},
    {"召唤骷髅1级","毒龙剑","BB加成3"},
    {"召唤骷髅2级","毒龙剑","BB加成3"},
    {"召唤骷髅3级","毒龙剑","BB加成3"},
    {"召唤骷髅4级","毒龙剑","BB加成3"},
    {"召唤神兽1级","毒龙剑","BB加成3"},
    {"召唤神兽2级","毒龙剑","BB加成3"},
    {"召唤神兽3级","毒龙剑","BB加成3"},
    {"召唤神兽4级","毒龙剑","BB加成3"},
    {"骷髅（射手印）","毒龙剑","BB加成3"},
    {"骷髅（战将印）","毒龙剑","BB加成3"},
    {"骷髅（帝王印）","毒龙剑","BB加成3"},
    {"神兽（圣兽印）","毒龙剑","BB加成3"},
    {"神兽（血兽印）","毒龙剑","BB加成3"},
    {"神兽（天神印）","毒龙剑","BB加成3"},
    {"召唤骷髅1级","孔雀翎","BB加成3"},
    {"召唤骷髅2级","孔雀翎","BB加成3"},
    {"召唤骷髅3级","孔雀翎","BB加成3"},
    {"召唤骷髅4级","孔雀翎","BB加成3"},
    {"召唤神兽1级","孔雀翎","BB加成3"},
    {"召唤神兽2级","孔雀翎","BB加成3"},
    {"召唤神兽3级","孔雀翎","BB加成3"},
    {"召唤神兽4级","孔雀翎","BB加成3"},
    {"骷髅（射手印）","孔雀翎","BB加成3"},
    {"骷髅（战将印）","孔雀翎","BB加成3"},
    {"骷髅（帝王印）","孔雀翎","BB加成3"},
    {"神兽（圣兽印）","孔雀翎","BB加成3"},
    {"神兽（血兽印）","孔雀翎","BB加成3"},
    {"神兽（天神印）","孔雀翎","BB加成3"},

}

-------------技巧项链---------------------
function on_spell(player, id, name, x, y, target, key)--此处是技巧项链
    local neck = "技巧项链"	--技巧项链索引名
    local skills = {
        ["普通物理攻击"] = 1,--什么技能不需要设置熟练度
    }
    if lualib:GUIDType(player) == 0 and skills[key] == nil then
        local item = lualib:Necklace(player)
        if item ~= "" then
            if lualib:KeyName(item) == neck then
                lualib:DelayCall(player, 100, "set_skill_exp", key)
            end
        end
    end
    if lualib:GUIDType(player) == 0 and petskill[key] ~= nil then
        local list = lualib:Player_GetServantList(player)
        if #list > 0 then
            for _, v in ipairs(list) do
                lualib:Monster_Remove(v)
            end
        end
    end

    local weapon = lualib:Weapon(player)
    if weapon == "" then
        return ""
    end
    local wq_key = lualib:Name(weapon)
    local bb_tb = lualib:Player_GetServantList(player)
    for i=1,#bb_sx do
        if wq_key == bb_sx[i][2] and key == bb_sx[i][1] then
            if bb_tb ~= "" then
                for k,v in pairs(bb_tb) do
                    lualib:AddBuff(v,bb_sx[i][3],0)
                end
            end
        end
    end

end

function set_skill_exp(player, key)--技巧项链回调函数
    local shulian = lualib:GetSkillExp(player, key)
    local exps = math.random(1,3)
    lualib:SetSkillExp(player, key, shulian + exps)
end

-------------几级才可摆摊---------------------
function on_pre_stall(player)
    if lualib:GetInt(player,"初次摆摊") == 0 then
        lualib:SetInt(player,"初次摆摊",1)
        lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【初次摆摊】成就，可前往领取奖励！", 1500)
    end
    local Level = lualib:Level(player)
    if Level < 10 then
        lualib:SysMsg_SendTriggerMsg(player,"25级才可摆摊")
        return false
    end
    return true
end

local gz_item = {
    [1] = {
        [1] = {{"井中月","炼狱","龙之戒指","幽灵项链","幽灵手套","战神盔甲(男)","战神盔甲(女)","疾风","记忆手镯","记忆戒指","记忆头盔","记忆项链","井中月1"},"300000810"},
        [2] = {{"裁决之杖","绿色项链","骑士手镯","力量戒指","黑铁头盔","裁决之杖2","裁决之杖3","裁决之杖4","九尾冰狐","命运之刃战25","命运之刃战30","命运之刃战35","命运之刃"},"300000812"},
        [3] = {{"屠龙","圣战头盔","圣战项链","圣战手镯","圣战戒指","圣战宝甲","天魔神甲","怒斩","大角羊","怒斩1"},"300000813"},
        [4] = {{"铜域戒指","铜域手镯","铜域项链","铜域头盔","绝影豹"},"300000811"},
        [5] = {{"龙血宝刀","古剑无名","幽冥鬼斩","静寂战袍","静寂战甲","九尾火狐","熔岩犀牛"},"300000814"},
    },

    [2] = {
        [1] = {{"血饮","魔杖","红宝石戒指","生命项链","思贝儿手镯","恶魔长袍(男)","恶魔长袍(女)","疾风","血饮1"},"300000810"},
        [2] = {{"骨玉权杖","恶魔铃铛","龙之手镯","紫碧螺","黑铁头盔","骨玉权杖2","骨玉权杖3","骨玉权杖4","九尾冰狐","命运之刃法25","命运之刃法30","命运之刃法35"},"300000812"},
        [3] = {{"嗜魂法杖","法神头盔","法神项链","法神手镯","法神戒指","法神披风","霓裳羽衣","龙牙","大角羊","龙牙1"},"300000813"},
        [4] = {{"水域头盔","水域项链","水域手镯","水域戒指","绝影豹"},"300000811"},
        [5] = {{"七星法杖","火灵权杖","寒玉剑","静寂羽衣","静寂披风","九尾火狐","熔岩犀牛"},"300000814"},
    },

    [3] = {
        [1] = {{"无极棍","银蛇","铂金戒指","天珠项链","心灵手镯","幽灵战衣(男)","幽灵战衣(女)","疾风","无极棍1"},"300000810"},
        [2] = {{"龙纹剑","灵魂项链","三眼手镯","泰坦戒指","黑铁头盔","龙纹剑2","龙纹剑3","龙纹剑4","九尾冰狐","命运之刃道25","命运之刃道30","命运之刃道35"},"300000812"},
        [3] = {{"逍遥扇","天尊头盔","天尊项链","天尊手镯","天尊戒指","天尊道袍","天师长袍","六道轮回拂","大角羊","逍遥扇1"},"300000813"},
        [4] = {{"土域戒指","土域手镯","土域项链","土域头盔","绝影豹"},"300000811"},
        [5] = {{"火冥宝剑","毒龙剑","孔雀翎","静寂道衣","静寂道袍","九尾火狐","熔岩犀牛"},"300000814"},
    },

}

local appear_items = {
    {"屠龙1123",2}
}

function on_item_appear(map, item, item_id, item_key, x, y)
    for i, v in pairs(appear_items) do
        if item_key == v[1] then
            if lualib:GetDBNum(item_key) == v[2] then
                local diaoluo_guid = lualib:ItemDropHost(item)
                if not lualib:Player_IsPlayer(diaoluo_guid) then
                    lualib:Item_MapRemove(item,"多了","洪子涵")
                    return ""
                end
            else
                local diaoluo_guid = lualib:ItemDropHost(item)
                if not lualib:Player_IsPlayer(diaoluo_guid) then
                    local num = lualib:GetDBNum(item_key)
                    num = num + 1
                    lualib:SetDBNumEx(item_key,num,6)
                end
            end
        end
    end

    for k2,v2 in pairs(gz_item) do
        for k=1,3 do
            for number=1,5 do
                for i=1,20 do
                    if item_key == gz_item[k][number][1][i] then
                        lualib:RunClientScript(map, "ItemEffect", "texiao", gz_item[k][number][2].."#"..x.."#"..y.."#0#9999999");
                        return ""
                    end
                end
            end
        end
    end
    return ""
end

function on_item_disappear(map, item, item_id, item_key, x, y)

    for k2,v2 in pairs(gz_item) do
        for k=1,3 do
            for number=1,5 do
                for i=1,20 do
                    if item_key == gz_item[k][number][1][i] then
                        lualib:RunClientScript(map, "ItemEffect", "del_texiao", gz_item[k][number][2].."#"..x.."#"..y);
                        return ""
                    end
                end
            end
        end
    end

end

local zhaohuanwu = {
    {"龙纹剑","BB加成"},
    {"龙纹剑1","BB加成"},
    {"龙纹剑2","BB加成"},
    {"龙纹剑3","BB加成"},
    {"逍遥扇","BB加成1"},
    {"六道轮回拂","BB加成2"},
    {"火冥宝剑","BB加成3"},
    {"毒龙剑","BB加成3"},
    {"孔雀翎","BB加成3"},
}

local zb_job = {
    [1] = {"铜域头盔","铜域项链","铜域戒指","铜域手镯","擒龙手"},
    [2] = {"水域头盔","水域项链","水域戒指","水域手镯","分身术"},
    [3] = {"土域头盔","土域项链","土域戒指","土域手镯","噬血术"},
}

--穿装备触发回调
function on_post_equip(player, item_Guid, item_ID, item_keyname)
    if lualib:GUIDType(player) == 0 then
        if lualib:GetInt(player,"第一件装备") == 0 then
            lualib:SetInt(player,"第一件装备",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【第一件装备】成就，可前往领取奖励！", 1500)
        end
    end
    local F_skill = lualib:GetStr(item_Guid, "new_skill_1")--第一个印记
    local skill_num = lualib:GetInt(item_Guid, "skill_num")--条数
    if  F_skill ~= ""  then
        for i=1,skill_num do
            local new_skill = lualib:GetStr(item_Guid, "new_skill_"..tostring(i)) --替换后技能
            local old_skill = lualib:GetStr(item_Guid, "old_skill_"..tostring(i)) --替换前技能
            local level = lualib:GetStr(item_Guid, "skill_level_"..tostring(i)) --技能所在技能池
            --lualib:SysMsg_SendBroadcastMsg(tostring(new_skill), "替换后技能")

            if lualib:HasSkill(player, old_skill, false) then
                lualib:AddSkill(player, new_skill)
            end
        end
        --[[        local list = lualib:Player_GetServantList(player)
                if #list > 0 then
                    for _, v in ipairs(list) do
                        lualib:Monster_Remove(v)
                    end
                end--]]
    end

    local bb_tb = lualib:Player_GetServantList(player)
    for i=1,#zhaohuanwu do
        if item_keyname == zhaohuanwu[i][1] then
            if bb_tb ~= "" then
                for k,v in pairs(bb_tb) do
                    if lualib:HasBuff(v,zhaohuanwu[i][2]) == false then
                        lualib:AddBuff(v,zhaohuanwu[i][2],0)
                    end
                end
            end
        end
    end
    local job = lualib:Job(player)
    local tz_num = 0
    local tz_num1 = 0
    local ring0 = lualib:Ring(player, 0)
    local ring1 = lualib:Ring(player, 1)
    local wrist0 = lualib:Wrist(player, 0)
    local wrist1 = lualib:Wrist(player, 1)
    local necklace = lualib:Necklace(player)
    local helmet = lualib:Helmet(player)
    for k,v in ipairs(zb_job) do
        if k == job then
            if lualib:KeyName(helmet) == zb_job[k][1] then
                tz_num1 = tz_num1 + 1
            end
            if lualib:KeyName(necklace) == zb_job[k][2] then
                tz_num1 = tz_num1 + 1
            end
            if (lualib:KeyName(ring0) == zb_job[k][3] or lualib:KeyName(ring1) == zb_job[k][3]) and (lualib:KeyName(wrist0) == zb_job[k][4] or lualib:KeyName(wrist1) == zb_job[k][4]) then
                tz_num = tz_num + 2
                if tz_num + tz_num1 >= 4 and tz_num1 == 2 then
                    if not lualib:HasSkill(player,zb_job[k][5],false) then
                        lualib:AddSkill(player,zb_job[k][5])
                        lualib:MsgBox(player,"恭喜您激活技能"..zb_job[k][5].."！")
                        return ""
                    end
                end
            end
        end
    end

    local luck = lualib:LuckCurse(player)
    if luck == 9 then
        if not lualib:HasBuff(player,"沃玛套装战24") then  --运9光环
            lualib:AddBuff(player,"沃玛套装战24",0)
        end
    end


    return ""
end

--脱装备触发回调
function on_post_un_equip(player, item_Guid, item_ID, item_keyname)
    if item_keyname == "天书" then
        local time = lualib:Str2Time(lualib:Now())
        lualib:SetInt(player,"tianshuTime",time+10)
    end
    --lualib:SysMsg_SendBroadcastMsg(tostring(item_keyname).."---"..tostring(item_ID), "脱装备")
    local F_skill = lualib:GetStr(item_Guid, "new_skill_1")--第一个印记
    local skill_num = lualib:GetInt(item_Guid, "skill_num")--条数
    local magic_bb_flag = false
    if  F_skill ~= ""  then
        for i=1,skill_num do
            local new_skill = lualib:GetStr(item_Guid, "new_skill_"..tostring(i)) --替换后技能
            local old_skill = lualib:GetStr(item_Guid, "old_skill_"..tostring(i)) --替换前技能
            local level = lualib:GetStr(item_Guid, "skill_level_"..tostring(i)) --技能所在技能池
            --lualib:SysMsg_SendBroadcastMsg(tostring(new_skill), "替换后技能")
            if old_skill == "诱惑之光4级" then
                magic_bb_flag = true
            end
            if lualib:HasSkill(player, new_skill, false) then
                lualib:AddSkill(player, old_skill)
                --lualib:SysMsg_SendBroadcastMsg(tostring(old_skill), "添加")
            end
        end
        local list = lualib:Player_GetServantList(player)
        if #list > 0 then
            if lualib:Job(player) == 2 then
                if magic_bb_flag then
                    for _, v in ipairs(list) do
                        --lualib:SysMsg_SendBroadcastMsg(tostring("删除了"), "法师")

                        lualib:Monster_Remove(v)
                    end
                end
            else
                for _, v in ipairs(list) do
                    --lualib:SysMsg_SendBroadcastMsg(tostring("删除了"), "非法师")
                    lualib:Monster_Remove(v)
                end
            end
        end
    end
    local bb_tb = lualib:Player_GetServantList(player)
    for i=1,#zhaohuanwu do
        if item_keyname == zhaohuanwu[i][1] then
            if bb_tb ~= "" then
                for k,v in pairs(bb_tb) do
                    if lualib:HasBuff(v,zhaohuanwu[i][2]) then
                        lualib:DelBuff(v,zhaohuanwu[i][2])
                    end
                end
            end
        end
    end

    local job = lualib:Job(player)
    local tz_num = 0
    local tz_num1 = 2
    local ring0 = lualib:Ring(player, 0)
    local ring1 = lualib:Ring(player, 1)
    local wrist0 = lualib:Wrist(player, 0)
    local wrist1 = lualib:Wrist(player, 1)
    local necklace = lualib:Necklace(player)
    local helmet = lualib:Helmet(player)
    for k,v in ipairs(zb_job) do
        if k == job then
            if lualib:KeyName(helmet) ~= zb_job[k][1] then
                if  lualib:HasSkill(player,zb_job[k][5],false) then
                    lualib:DelSkill(player,zb_job[k][5])
                    lualib:MsgBox(player,"您失去了套装效果，"..zb_job[k][5].."技能被删除了！")
                    return ""
                end
            end

            if lualib:KeyName(necklace) ~= zb_job[k][2] then
                if  lualib:HasSkill(player,zb_job[k][5],false) then
                    lualib:DelSkill(player,zb_job[k][5])
                    lualib:MsgBox(player,"您失去了套装效果，"..zb_job[k][5].."技能被删除了！")
                    return ""
                end
            end
            if lualib:KeyName(ring0) ~= zb_job[k][3] and lualib:KeyName(ring1) ~= zb_job[k][3] then
                if  lualib:HasSkill(player,zb_job[k][5],false) then
                    lualib:DelSkill(player,zb_job[k][5])
                    lualib:MsgBox(player,"您失去了套装效果，"..zb_job[k][5].."技能被删除了！")
                    return ""
                end
            end
            if lualib:KeyName(wrist0) ~= zb_job[k][4] and lualib:KeyName(wrist1) ~= zb_job[k][4] then
                if  lualib:HasSkill(player,zb_job[k][5],false) then
                    lualib:DelSkill(player,zb_job[k][5])
                    lualib:MsgBox(player,"您失去了套装效果，"..zb_job[k][5].."技能被删除了！")
                    return ""
                end
            end
        end
    end

    local luck = lualib:LuckCurse(player)
    if luck ~= 9 then
        if lualib:HasBuff(player,"沃玛套装战24") then  --运9光环
            lualib:DelBuff(player,"沃玛套装战24")
        end
    end

    return ""
end

local monster_tab = {
    "楔蛾阁","楔蛾","角蝇阁","角蝇","大老鼠大爆","大老鼠","僵尸爬大爆","僵尸爬","僵尸电大爆","僵尸电","僵尸地大爆","僵尸地","僵尸刀大爆","僵尸刀",
    "僵尸大爆","僵尸3","僵尸2","洞蛆","山洞蝙蝠大爆","山洞蝙蝠","森林雪人","骷髅战士大爆","骷髅战士","骷髅战将","骷髅战将大爆","骷髅大爆","骷髅","粪虫","半兽战士","半兽勇士","半兽人",
    "掷斧骷髅大爆","掷斧骷髅","骷髅精灵","蝙蝠","爆裂蜘蛛",
}
--天书升级对应设置table
local ts_tb = {-- 属性类型值，字段名，字段名(value)，说明
    {6,"_da1","_dv1","物防上限"},
    {8,"_da2","_dv2","魔防上限"},
    {10,"_da3","_dv3","物攻上限"},
    {12,"_da4","_dv4","魔攻上限"},
    {14,"_da5","_dv5","道术上限"},
}

local ts_nums_tb = {--几只怪，几级，value，升级还需
    {1,1,1,5000},
    {5000,2,2,20000},
    {20000,3,3,40000},
    {40000,4,4,60000},
    {60000,5,5,80000},
    {80000,6,6,0},
}

local wm_monster = {"火焰沃玛","火焰沃玛大爆","沃玛战士大爆","沃玛勇士","沃玛战将","沃玛战士","沃玛卫士","沃玛卫士书","沃玛卫士首饰","沃玛战将大爆","沃玛勇士大爆","暗黑战士"}
local wg_monster = {"邪恶钳虫","蜈蚣大爆","黑色恶蛆","钳虫","跳跳蜂","蜈蚣","黑色恶蛆大爆","钳虫大爆","跳跳蜂大爆","巨型蠕虫","巨型蠕虫大爆","邪恶钳虫假"}
local zd_monster = {"白野猪药","黑野猪","红野猪","角蝇","蝎蛇","蝎蛇大爆","蝎蛇极","黑野猪极","红野猪极","红野猪大爆","黑野猪大爆"}
local zm_monster = {"祖犸卫士","祖犸弓箭手","祖犸雕像","楔蛾","大老鼠","大老鼠大爆","祖犸雕像极假","祖犸弓手极假","祖犸卫士极假","祖犸卫士普","祖犸雕像普","祖犸卫士超","祖犸弓手普","祖犸雕像极装","祖犸卫士极书",
                    "祖犸卫士极装","祖犸弓手极装","祖犸弓手极书","祖犸雕像极书","祖犸雕像普阁","角蝇阁","楔蛾阁","祖犸卫士普阁","祖犸弓手普阁"}
local nm_monster = {"牛魔斗士","牛魔战士","牛魔法师","牛魔将军","牛魔将军装","牛魔将军无","牛魔祭司装","牛魔祭司","牛魔祭司无"}
local cy_monster = {"暴牙蜘蛛","钢牙蜘蛛","黑锷蜘蛛","花吻蜘蛛","血僵尸","血巨人","天狼蜘蛛"}
local sw_monster = {"尸王30","尸王殿","尸王殿大爆","尸王35","尸王"}


--怪物死亡时回调
function on_post_monster_die(monster, Killer)
    if lualib:GUIDType(Killer) == 0 then
        local monster_keyName = lualib:KeyName(monster)
        local monster_name = lualib:Name(monster)

        for i=1,#sw_monster do
            if monster_keyName == sw_monster[i] then
                if lualib:GetInt(Killer,"shiwang_zfz") == 100 then
                    if lualib:GetInt(Killer,"尸王征服者") == 0 then
                        lualib:SetInt(Killer,"尸王征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【尸王征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"shiwang_zfz") < 100 then
                    lualib:SetInt(Killer,"shiwang_zfz",lualib:GetInt(Killer,"shiwang_zfz")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『尸王』："..lualib:GetInt(Killer,"shiwang_zfz").."只")
                end
            end
        end

        if monster_name == "铁甲钳虫王" then
            if lualib:GetInt(Killer,"xieerqianc_ss") == 100 then
                if lualib:GetInt(Killer,"铁甲钳虫王杀手") == 0 then
                    lualib:SetInt(Killer,"铁甲钳虫王杀手",1)
                    lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【铁甲钳虫王杀手】成就，可前往领取奖励！", 1500)
                end
            elseif lualib:GetInt(Killer,"xieerqianc_ss") < 100 then
                lualib:SetInt(Killer,"xieerqianc_ss",lualib:GetInt(Killer,"xieerqianc_ss")+1)
                --lualib:SysTriggerMsg(Killer,"当前已杀『邪恶钳虫』："..lualib:GetInt(Killer,"xieerqianc_ss").."只")
            end
        end

        if monster_keyName == "白野猪药" then
            if lualib:GetInt(Killer,"baiyezhu_kx") == 100 then
                if lualib:GetInt(Killer,"白野猪克星") == 0 then
                    lualib:SetInt(Killer,"白野猪克星",1)
                    lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【白野猪克星】成就，可前往领取奖励！", 1500)
                end
            elseif lualib:GetInt(Killer,"baiyezhu_kx") < 100 then
                lualib:SetInt(Killer,"baiyezhu_kx",lualib:GetInt(Killer,"baiyezhu_kx")+1)
                --lualib:SysTriggerMsg(Killer,"当前已杀『白野猪』："..lualib:GetInt(Killer,"baiyezhu_kx").."只")
            end
        end

        if monster_keyName == "沃玛教主" or monster_keyName == "暗之沃玛教主" then
            if lualib:Player_HasTeam(Killer) then
                local teamguid_tb = lualib:Player_GetTeamList(Killer)
                for _,v in pairs(teamguid_tb) do
                    if lualib:GetInt(v,"挑战奥马教主") == 0 then
                        lualib:SetInt(v,"挑战奥马教主",1)
                        lualib:SysMsg_SendBoardMsg(v, "[英雄成就]", "恭喜你达成了【挑战奥马教主】成就，可前往领取奖励！", 1500)
                    end
                end
            else
                if lualib:GetInt(Killer,"挑战奥马教主") == 0 then
                    lualib:SetInt(Killer,"挑战奥马教主",1)
                    lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【挑战奥马教主】成就，可前往领取奖励！", 1500)
                end
            end
        end

        if monster_name == "祖犸教主"  then
            if lualib:Player_HasTeam(Killer) then
                local teamguid_tb = lualib:Player_GetTeamList(Killer)
                for _,v in pairs(teamguid_tb) do
                    if lualib:GetInt(v,"挑战祖玛教主") == 0 then
                        lualib:SetInt(v,"挑战祖玛教主",1)
                        lualib:SysMsg_SendBoardMsg(v, "[英雄成就]", "恭喜你达成了【挑战祖玛教主】成就，可前往领取奖励！", 1500)
                    end
                end
            else
                if lualib:GetInt(Killer,"挑战祖玛教主") == 0 then
                    lualib:SetInt(Killer,"挑战祖玛教主",1)
                    lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【挑战祖玛教主】成就，可前往领取奖励！", 1500)
                end
            end
        end

        if monster_name == "赤月恶魔" then
            if lualib:Player_HasTeam(Killer) then
                local teamguid_tb = lualib:Player_GetTeamList(Killer)
                for _,v in pairs(teamguid_tb) do
                    if lualib:GetInt(v,"挑战赤月老魔") == 0 then
                        lualib:SetInt(v,"挑战赤月老魔",1)
                        lualib:SysMsg_SendBoardMsg(v, "[英雄成就]", "恭喜你达成了【挑战赤月老魔】成就，可前往领取奖励！", 1500)
                    end
                end
            else
                if lualib:GetInt(Killer,"挑战赤月老魔") == 0 then
                    lualib:SetInt(Killer,"挑战赤月老魔",1)
                    lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【挑战赤月老魔】成就，可前往领取奖励！", 1500)
                end
            end
        end

        if monster_name == "牛魔王" then
            if lualib:Player_HasTeam(Killer) then
                local teamguid_tb = lualib:Player_GetTeamList(Killer)
                for _,v in pairs(teamguid_tb) do
                    if lualib:GetInt(v,"挑战牛魔王") == 0 then
                        lualib:SetInt(v,"挑战牛魔王",1)
                        lualib:SysMsg_SendBoardMsg(v, "[英雄成就]", "恭喜你达成了【挑战牛魔王】成就，可前往领取奖励！", 1500)
                    end
                end
            else
                if lualib:GetInt(Killer,"挑战牛魔王") == 0 then
                    lualib:SetInt(Killer,"挑战牛魔王",1)
                    lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【挑战牛魔王】成就，可前往领取奖励！", 1500)
                end
            end
        end

        for i=1,#wm_monster do
            if monster_keyName == wm_monster[i] then
                if lualib:GetInt(Killer,"wm_monster") == 1000 then
                    if lualib:GetInt(Killer,"奥玛征服者") == 0 then
                        lualib:SetInt(Killer,"奥玛征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【奥玛征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"wm_monster") < 1000 then
                    lualib:SetInt(Killer,"wm_monster",lualib:GetInt(Killer,"wm_monster")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『奥玛怪物』："..lualib:GetInt(Killer,"wm_monster").."只")
                end
            end
        end

        for i=1,#wg_monster do
            if monster_keyName == wg_monster[i] then
                if lualib:GetInt(Killer,"wg_monster") == 2000 then
                    if lualib:GetInt(Killer,"地牢征服者") == 0 then
                        lualib:SetInt(Killer,"地牢征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【地牢征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"wg_monster") < 2000 then
                    lualib:SetInt(Killer,"wg_monster",lualib:GetInt(Killer,"wg_monster")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『地牢怪物』："..lualib:GetInt(Killer,"wg_monster").."只")
                end
            end
        end

        for i=1,#zd_monster do
            if monster_keyName == zd_monster[i] then
                if lualib:GetInt(Killer,"zd_monster") == 3000 then
                    if lualib:GetInt(Killer,"猪洞征服者") == 0 then
                        lualib:SetInt(Killer,"猪洞征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【猪洞征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"zd_monster") < 3000 then
                    lualib:SetInt(Killer,"zd_monster",lualib:GetInt(Killer,"zd_monster")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『猪洞怪物』："..lualib:GetInt(Killer,"zd_monster").."只")
                end
            end
        end

        for i=1,#zm_monster do
            if monster_keyName == zm_monster[i] then
                if lualib:GetInt(Killer,"zm_monster") == 3000 then
                    if lualib:GetInt(Killer,"祖犸征服者") == 0 then
                        lualib:SetInt(Killer,"祖犸征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【祖犸征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"zm_monster") < 3000 then
                    lualib:SetInt(Killer,"zm_monster",lualib:GetInt(Killer,"zm_monster")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『祖犸怪物』："..lualib:GetInt(Killer,"zm_monster").."只")
                end
            end
        end

        for i=1,#nm_monster do
            if monster_keyName == nm_monster[i] then
                if lualib:GetInt(Killer,"nm_monster") == 3000 then
                    if lualib:GetInt(Killer,"牛魔寺庙征服者") == 0 then
                        lualib:SetInt(Killer,"牛魔寺庙征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【牛魔寺庙征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"nm_monster") < 3000 then
                    lualib:SetInt(Killer,"nm_monster",lualib:GetInt(Killer,"nm_monster")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『牛魔怪物』："..lualib:GetInt(Killer,"nm_monster").."只")
                end
            end
        end

        for i=1,#cy_monster do
            if monster_keyName == cy_monster[i] then
                if lualib:GetInt(Killer,"cy_monster") == 3000 then
                    if lualib:GetInt(Killer,"赤月征服者") == 0 then
                        lualib:SetInt(Killer,"赤月征服者",1)
                        lualib:SysMsg_SendBoardMsg(Killer, "[英雄成就]", "恭喜你达成了【赤月征服者】成就，可前往领取奖励！", 1500)
                    end
                elseif lualib:GetInt(Killer,"cy_monster") < 3000 then
                    lualib:SetInt(Killer,"cy_monster",lualib:GetInt(Killer,"cy_monster")+1)
                    --lualib:SysTriggerMsg(Killer,"当前已杀『赤月怪物』："..lualib:GetInt(Killer,"cy_monster").."只")
                end
            end
        end
    end

    if Killer == "" then return "" end

    if not lualib:Player_IsPlayer(Killer) then
        local player_name = lualib:Monster_GetMaster(Killer)
        Killer = lualib:Name2Guid(player_name)
        if Killer == "" then return "" end
    end
    local map_guid = lualib:MapGuid(Killer)
    local map_name = lualib:KeyName(map_guid)
    if map_name == "龙城" or map_name == "巫山城" then
        return ""
    end
    local tianshu = lualib:Player_GetItemGuid(Killer, 14)

    if tianshu ~= "" then
        local monster_keyname = lualib:KeyName(monster)
        local kill_num = lualib:GetInt(tianshu,"kill_num")
        local flag = true
        for i,v in pairs(monster_tab) do
            if v == monster_keyname then
                flag = false
            end
        end
        if flag then
            kill_num = kill_num + 1
        end
        lualib:SetInt(tianshu,"kill_num",kill_num)

        for i,v in pairs(ts_nums_tb) do
            if kill_num == v[1] then
                for j=1,#ts_tb do
                    lualib:SetInt(tianshu,"_da"..tostring(j),ts_tb[j][1])
                    lualib:SetInt(tianshu,"_dv"..tostring(j),v[3])

                    if v[3] % 2 == 0 then
                        lualib:SetInt(tianshu,"_da6",49)
                        lualib:SetInt(tianshu,"_dv6",(v[3]/2))
                    end
                end
                lualib:SetInt(tianshu,"tianshu_level",v[3])
                lualib:SetInt(tianshu,"level_up_kill_num",v[4])
                lualib:SetInt(tianshu,"now_level_kill_num",v[1])
            end
        end
        lualib:Item_NotifyUpdate("",tianshu)
    end
    return ""
end

local tb_wuqi = {"屠龙","嗜魂法杖","六道轮回拂"}
local tb_yifu = {"静寂战袍","静寂战甲","静寂羽衣","静寂披风","静寂道衣","静寂道袍"}

local xl_xy = {
    {"白色虎齿项链",300,100,50,10,1},
    {"灯笼项链",300,100,50,10,1},
    {"记忆项链",0,0,0,10,1},
}

--角色拾取道具时回调
function on_item_pickup(player,item,id,item_key)


    --武器
    if item_key == tb_wuqi[1] or item_key == tb_wuqi[2] or item_key == tb_wuqi[3] then
        if player ~= "" then
            if lualib:GetDBNum(item) == 1 then
                local name = lualib:Name(player)
                local accountName = lualib:AccountName(player)
                local job = lualib:Job(player)
                if lualib:GetDBNum("tulongshuliang") < 5 then
                    lualib:SetDBNumEx("tulong#"..accountName.."#"..name.."#"..job,1,0)
                    lualib:SetDBNum(item,2)
                end
            end
        end
    end
    --衣服
    if item_key == tb_yifu[1] or item_key == tb_yifu[2] or item_key == tb_yifu[3] or item_key == tb_yifu[4] or item_key == tb_yifu[5] or item_key == tb_yifu[6] then
        if player ~= "" then
            if lualib:GetDBNum(item) == 1 then
                local name = lualib:Name(player)
                local accountName = lualib:AccountName(player)
                local job = lualib:Job(player)
                if lualib:GetDBNum("yifushuliang") < 10 then
                    lualib:SetDBNumEx("tianmo#"..accountName.."#"..name.."#"..job,1,0)
                    lualib:SetDBNum(item,2)
                end
            end
        end
    end
    local r = lualib:GenRandom(1,10000)

    if player ~= "" then
        if lualib:GetInt(item,"xingyunxl") ~= 1 then
            for i=1,#xl_xy do
                if lualib:KeyName(item) == xl_xy[i][1] then
                    if r <= xl_xy[i][6] then
                        --lualib:SysMsg_SendBroadcastMsg(tostring(2), "")

                        lualib:Equip_SetLuckCurse("",item,2)
                        lualib:SetInt(item,"xingyunxl",1)
                        break
                    elseif r <= xl_xy[i][5] then
                        --lualib:SysMsg_SendBroadcastMsg(tostring(1), "")

                        lualib:Equip_SetLuckCurse("",item,1)
                        lualib:SetInt(item,"xingyunxl",1)
                        break
                    elseif r <= xl_xy[i][4] then
                        --lualib:SysMsg_SendBroadcastMsg(tostring(30), "")

                        for i=0,5 do
                            local QualProp = lualib:Equip_GetQualProp(player,item,i)
                            if QualProp[0] == 0 then
                                lualib:Equip_SetQualProp(player,item,i,194,20)
                                lualib:Item_NotifyUpdate(player, item)
                                break
                            end
                        end
                        lualib:SetInt(item,"xingyunxl",1)
                        break
                    elseif r <= xl_xy[i][3] then
                        --lualib:SysMsg_SendBroadcastMsg(tostring(20), "")

                        for i=0,5 do
                            local QualProp = lualib:Equip_GetQualProp(player,item,i)
                            if QualProp[0] == 0 then
                                lualib:Equip_SetQualProp(player,item,i,194,10)
                                lualib:Item_NotifyUpdate(player, item)
                                break
                            end
                        end
                        lualib:SetInt(item,"xingyunxl",1)
                        break
                    elseif r <= xl_xy[i][2] then
                        --lualib:SysMsg_SendBroadcastMsg(tostring(10), "")

                        for i=0,5 do
                            local QualProp = lualib:Equip_GetQualProp(player,item,i)
                            --lualib:SysMsg_SendBroadcastMsg(tostring(QualProp[0]), tostring(i))

                            if QualProp[0] == 0 then
                                lualib:Equip_SetQualProp(player,item,i,194,10)
                                lualib:Item_NotifyUpdate(player, item)
                                break
                            end
                        end
                        lualib:SetInt(item,"xingyunxl",1)
                        break
                    else
                        lualib:Equip_SetLuckCurse("",item,0)
                        lualib:SetInt(item,"xingyunxl",1)
                    end
                end
            end
        end
    end
end
local useDrop = {
    "魔法盾","召唤神兽","烈火剑法","龙纹剑","骨玉法杖",
}
--怒斩 逍遥扇 龙牙 屠龙

--{["max"] = 0,["daynum"] = 0,["hasgot"] = 0,["can"] = "",["hasdrop"] = {},["isopen"] = 0}

function on_pre_drop_one(map,player,item,id)
    local item_key = lualib:KeyName(item)
    --lualib:SysMsg_SendBroadcastMsg(tostring(item_key), "item_key1")

    if lualib:Monster_IsMonster(player) then
        local pl = lualib:Monster_GetDropOwner(player)
        local pl_Accname = lualib:AccountName(pl)
        local pl_name = lualib:Name(pl)
        if lualib:GetInt(pl,"waiguatest") > 0 then
            --lualib:SysMsg_SendBroadcastMsg(tostring("GB"), "GB")
            lualib:SysWarnMsg(pl,"收益制裁！！！")
            return false
        end
        local dropTable = GetJson("DropShow")
        for i,v in pairs(useDrop) do
            if v == item_key then
                --lualib:SysMsg_SendBroadcastMsg(tostring(dropTable[v]), "dropTable[v]")
                if dropTable[v] == nil then
                    dropTable[v] = 1
                else
                    dropTable[v] = dropTable[v] + 1
                end
            end
        end
        SetJson(dropTable,"DropShow")
        for i,v in pairs(itemtb) do
            --lualib:SysMsg_SendBroadcastMsg(tostring(v), "v")

            if item_key == v then
                local jsonStr = lualib:GetDBStr(v)
                local tb = json.decode(jsonStr)
                --lualib:SysMsg_SendBroadcastMsg(tostring(tb["isopen"]), "tb")
                --lualib:SysMsg_SendBroadcastMsg(tostring(type(tb["isopen"])), "tb")
                if tb["isopen"] ~= 1 then
                    return false
                end
                if tb["hasgot"] < tb["max"] then
                    if pl_Accname == tb["can"] then
                        --lualib:SysMsg_SendBroadcastMsg(tostring("进图"), "1")

                        --local s = tb["hasdrop"]
                        tb["hasgot"] =  tb["hasgot"] + 1
                        table.insert(tb["hasdrop"],pl_name)
                        local jsonStr = json.encode(tb)
                        lualib:SetDBStrEx(v,jsonStr,6)
                        return true
                    elseif tb["can"] == "" then
                        tb["hasgot"] =  tb["hasgot"] + 1
                        table.insert(tb["hasdrop"],pl_name)
                        local jsonStr = json.encode(tb)
                        lualib:SetDBStrEx(v,jsonStr,6)
                        return true
                    else
                        return false
                    end
                else
                    return false
                end
            end
        end
    end
    return true
end

function SetJson(useTable,name)
    local str = json.encode(useTable)
    lualib:SetDBStr(name,str)
    --lualib:SysMsg_SendBroadcastMsg(tostring(str), "JSON")
    return ""
end

function GetJson(name)
    local str = lualib:GetDBStr(name)
    if str == "" then
        local dropTable = {
            ["白色虎齿项链"] = 1,
        }
        return dropTable
    end
    local useTable = json.decode(str)
    return useTable
end

function on_post_drop_one(map,player,item,id)
    --武器
    local item_key = lualib:KeyName(item)
    if item_key == tb_wuqi[1] or item_key == tb_wuqi[2] or item_key == tb_wuqi[3] then
        if player ~= "" then
            if lualib:GetDBNum("tulongshuliang") < 5 then
                lualib:SetDBNum(item,1)
                --lualib:SetDBNumEx("tulong#"..accountName.."#"..name.."#"..job,1,0)
                lualib:SetDBNumEx("tulongshuliang",lualib:GetDBNum("tulongshuliang")+1,4)
            end
        end
    end
    --衣服
    if item_key == tb_yifu[1] or item_key == tb_yifu[2] or item_key == tb_yifu[3] or item_key == tb_yifu[4] or item_key == tb_yifu[5] or item_key == tb_yifu[6] then
        if player ~= "" then
            if lualib:GetDBNum("yifushuliang") < 10 then
                lualib:SetDBNum(item,1)
                --lualib:SetDBNumEx("tianmo#"..accountName.."#"..name.."#"..job,1,0)
                lualib:SetDBNumEx("yifushuliang",lualib:GetDBNum("yifushuliang")+1,4)
            end
        end
    end

    return ""
end

function on_attack(player,attacker)
    if lualib:GUIDType(player) == 2 and lualib:GUIDType(attacker) == 0 then
        if lualib:GetInt(attacker,"第一次打怪") == 0 then
            lualib:SetInt(attacker,"第一次打怪",1)
            lualib:SysMsg_SendBoardMsg(attacker, "[英雄成就]", "恭喜你达成了【第一次打怪】成就，可前往领取奖励！", 1500)
        end
    end
end

local jineng_sanwu = {2120,2121,2122,2123,3110,3111,3112,3113,1050,1051,1052,1053}

function on_add_skill(player,skill_id)
    if lualib:GUIDType(player) == 0 then
        if lualib:GetInt(player,"第一个技能") == 0 then
            lualib:SetInt(player,"第一个技能",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【第一个技能】成就，可前往领取奖励！", 1500)
        end
    end
    if lualib:GetInt(player,"学习三十五技能") == 0 then
        for i=1,#jineng_sanwu do
            if skill_id == jineng_sanwu[i] then
                lualib:SetInt(player,"学习三十五技能",1)
                lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【学习三十五技能】成就，可前往领取奖励！", 1500)
            end
        end
    end
end

function on_pre_mining(player,map_keyName,skill_id,skill_name,skill_x,skill_y)
    if lualib:GetInt(player,"第一次挖矿") == 0 then
        lualib:SetInt(player,"第一次挖矿",1)
        lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【第一次挖矿】成就，可前往领取奖励！", 1500)
    end
    return true
end

function on_post_player_die(player,skller)
    if lualib:GetInt(player,"初次死亡") == 0 then
        lualib:SetInt(player,"初次死亡",1)
        lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【初次死亡】成就，可前往领取奖励！", 1500)
    end

    if lualib:Player_IsPlayer(skller) then
        if lualib:GetInt(skller,"第一次杀人") == 0 then
            lualib:SetInt(skller,"第一次杀人",1)
            lualib:SysMsg_SendBoardMsg(skller, "[英雄成就]", "恭喜你达成了【第一次杀人】成就，可前往领取奖励！", 1500)
        end
    end

    if lualib:GUIDType(skller) == 2 and lualib:Monster_GetMaster(skller) ~= "" then
        skller = lualib:Name2Guid(lualib:Monster_GetMaster(skller))
        if lualib:GetInt(skller,"第一次杀人") == 0 then
            lualib:SetInt(skller,"第一次杀人",1)
            lualib:SysMsg_SendBoardMsg(skller, "[英雄成就]", "恭喜你达成了【第一次杀人】成就，可前往领取奖励！", 1500)
        end
    end
    if lualib:Player_HasTeam(player) then
        lualib:LeaveTeam(player)
    end
    lualib:StopAutoRun(player)
    lualib:SetInt(player, "autoattack", 0)
    if lualib:HasTimer(player,999112) then
        lualib:DisableTimer(player,999112)
    end
end

function on_pre_item_apply(player,item,item_id,item_keyname)
    if item_keyname == "小喇叭" then
        if lualib:GetInt(player,"第一次喇叭") == 0 then
            lualib:SetInt(player,"第一次喇叭",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【第一次喇叭】成就，可前往领取奖励！", 1500)
        end
    end
    return true
end

function on_item_apply(player,item_id,item_keyname)
    if item_keyname == "小喇叭" then
        if lualib:GetInt(player,"第一次喇叭") == 0 then
            lualib:SetInt(player,"第一次喇叭",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【第一次喇叭】成就，可前往领取奖励！", 1500)
        end
    end
end

function on_family_member_ntf(hh_guid,hh_name,player,sj_type)
    if sj_type == 1 then
        if lualib:GetInt(player,"加入行会") == 0 then
            lualib:SetInt(player,"加入行会",1)
            lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "恭喜你达成了【加入行会】成就，可前往领取奖励！", 1500)
        end
    end
end

function on_pre_curse(player)
    if lualib:HasBuff(player,"庇护") then
        --lualib:SysMsg_SendBoardMsg(player, "[英雄成就]", "1234567", 1500)
        return false
    end
    return true
end

function on_monster_born(monster)
    return ""
end

-- @Usage: 玩家离开地图回调
-- @Time: 2020/1/16 13:45
-- @Author: Ken
-- @Param: strPlayer
--类型: string
--名称: 玩家的GUID.
--说明: 玩家的GUID.
-- @Return: 无
function on_leave_map(player)
    lualib:ShowFormWithContent(player, "脚本表单", [[GameMainBar.closeWnd()]])
end

-- @Usage: 玩家进入地图回调
-- @Time: 2020/2/21 16:13
-- @Author: Ken
-- @Param: playerGUID
-- @Return: 无
function on_enter_map(player)
    lualib:SetInt(player, "timeInMap", 0)
    --local keyName = lualib:KeyName(lualib:MapGuid(player))
    --if KeyName ~= "监狱" then
    --    lualib:SetStr(player, "vertifyIsRight", "")
    --end
end

function on_create(guid)
    if lualib:Monster_IsMonster(guid) then
        local name = lualib:KeyName(guid)
        if lualib:Monster_Type(name) == 4 then
            lualib:AddBuff(guid,"BOSS",1) --879
            --lualib:SysMsg_SendBroadcastMsg(tostring("boss"), "boss")

        elseif lualib:Monster_Type(name) == 2 then
            lualib:AddBuff(guid,"精英",1) --873
            --lualib:SysMsg_SendBroadcastMsg(tostring("精英"), "boss")

        end
    end
    return ""
end

function on_add_exp(player,exps)
    local level = lualib:Level(player)
    local now = lualib:GetAllTime()
    local start = lualib:GetConstVar("StartServerTime")
    local ser = lualib:Str2Time(start)
    local dis = now - ser
    if dis >= 0 and dis < 86400 and level == 40 then
        exps = exps/2
        lualib:SubExp(player,exps,"等级封印","等级封印")
        return
    end
    if dis >= 86400 and dis < 86400*3 and level == 45 then
        exps = exps/2
        lualib:SubExp(player,exps,"等级封印","等级封印")
        return
    end
    if dis >= 86400*3 and dis < 86400*10 and level == 50 then
        exps = exps/2
        lualib:SubExp(player,exps,"等级封印","等级封印")
        return
    end
    if dis >= 86400*10 and dis < 86400*20 and level == 55 then
        exps = exps/2
        lualib:SubExp(player,exps,"等级封印","等级封印")
        return
    end
    return
end

function on_pre_monster_die(monster,kill)
    --[[	local playername = lualib:Monster_GetMaster(monster)
        if lualib:KeyName(monster) == "鹰卫" then
            if playername ~= "" then
                local player = lualib:Name2Guid(playername)
                if lualib:GetInt(player,"yingwei") > 0 then
                    lualib:SetInt(player,"yingwei",lualib:GetInt(player,"yingwei")-1)
                end
                return true
            end
        end--]]
    return true
end

--[[function on_item_dur_zero_ex(player,item_guid,item_id,item_keyname)
	lualib:SysMsg_SendWarnMsg(player,"1")
	local leixing = lualib:Item_GetSubType(player,item_guid)
	if leixing == 20 then
		lualib:SysMsg_SendWarnMsg(player,"2")
		local sxz = lualib:GetInt(item_guid,"_dv60")
		local sxz1 = lualib:GetInt(item_guid,"_dv61")
		local yin_level = lualib:GetInt(item_guid,"yinzhang_level")
		lualib:SetInt(item_guid,"yin_level",yin_level)
		lualib:SetInt(item_guid,"menpai_shuxing2",sxz)
		lualib:SetInt(item_guid,"menpai_shuxing4",sxz1)
		lualib:SetInt(item_guid,"_dv60",0)
		lualib:SetInt(item_guid,"_dv61",0)
		lualib:SetInt(item_guid,"yinzhang_level",0)
	end
	return false
end--]]
function on_pre_equip(player,guid,id,keyname)
    if keyname == "天书" then
        local itemguid = lualib:Player_GetItemGuid(player,14)
        --local itemkeyname = lualib:KeyName(itemguid)
        --lualib:SysMsg_SendBroadcastMsg(tostring(itemkeyname), "item")

        if itemguid ~= "" then
            if not lualib:TakeOffEx(player,itemguid) then
                lualib:MsgBox(player,"系统错误")
                return false
            else
                local time = lualib:Str2Time(lualib:Now())
                local times = lualib:SetInt(player,"tianshuTime",time+10)
                if time < lualib:GetInt(player,"tianshuTime") then
                    lualib:SysMsg_SendWarnMsg(player,"穿戴天书冷却还有10秒")
                    return false
                end
            end
            return false
        else
            local time = lualib:Str2Time(lualib:Now())
            local times = lualib:GetInt(player,"tianshuTime")
            if time < lualib:GetInt(player,"tianshuTime") then
                lualib:SysMsg_SendWarnMsg(player,"穿戴天书冷却还有"..times-time.."秒")
                return false
            end
        end
    end
    return true
end
local skillCDTb = {
    ["野蛮冲击"] = {"野蛮（疾步印）","野蛮（麻痹印）","野蛮（撞击印）","野蛮（撞击印）"},
    ["裂地斩"] = {"开天（追龙印）","开天（血龙印）","开天（冰龙印）"},
    ["烈焰斩"] = {"烈火（狂暴印）","烈火（追月印）","烈火（雷神印）","烈火（燃烧印）"},
    ["陨星灭世"] = {"火雨（黑雨印）"},
    ["太极玄清术"] = {"太极（奥义印）"},
}

function on_pre_spell(player,skillID,skillName,x,y,target,skillKeyName )
    --for i,v in pairs(skillCDTb) do
    --    for j,k in pairs(v) do
    --        if k == skillKeyName then
    --            if lualib:HasBuff(player,i) then
    --                lualib:SysMsg_SendBroadcastMsg(tostring("技能冷却中"), "")
    --                return false
    --            else
    --                lualib:AddBuff(player,i,0)
    --                return true
    --            end
    --        end
    --    end
    --end
    return true
end